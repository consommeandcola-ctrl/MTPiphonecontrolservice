<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MTP Cloud Mobile v34.1</title>
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        /* --- Reset & Base --- */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Hiragino Sans", sans-serif; 
            background: #f0f2f5; 
            height: 100dvh; 
            color: #2d3748; 
            overflow: hidden; 
            display: flex;
            flex-direction: column;
        }
        input, textarea, select { user-select: text; }

        /* --- Header (Fixed) --- */
        .app-header {
            background: #1a202c; color: white; padding: 8px 10px;
            padding-top: env(safe-area-inset-top, 10px);
            flex-shrink: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .role-pill { font-size: 10px; background: #4a5568; padding: 2px 6px; border-radius: 4px; margin-left: 5px; }
        
        .status-badge { padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: bold; }
        .st-active { background: #e53e3e; color: white; animation: pulse 2s infinite; }
        .st-standby { background: #718096; color: white; }
        .st-completed { background: #2f855a; color: white; }

        /* Stats Bar */
        .stats-bar {
            display: grid; grid-template-columns: 1fr 1fr; gap: 5px;
            background: #2d3748; padding: 5px; border-radius: 6px;
        }
        .stat-group { display: flex; flex-direction: column; align-items: center; }
        .stat-label { font-size: 9px; color: #a0aec0; margin-bottom: 2px; }
        .stat-vals { display: flex; gap: 8px; font-size: 13px; font-weight: bold; font-family: monospace; }
        .c-red { color: #fc8181; } .c-yel { color: #f6e05e; } .c-blu { color: #63b3ed; }

        /* --- Main Viewport --- */
        .main-viewport {
            flex: 1; position: relative; overflow: hidden; background: #f7fafc;
        }
        .tab-view {
            position: absolute; inset: 0; 
            overflow-y: auto; -webkit-overflow-scrolling: touch;
            padding: 15px; padding-bottom: 80px;
            transform: translateX(100%); transition: transform 0.25s ease-out;
            display: none;
        }
        .tab-view.active-view { transform: translateX(0); display: block; }

        /* Read Only Mode Overlay */
        .read-only-overlay { position: relative; }
        .read-only-overlay::after {
            content: "å‚ç…§ãƒ¢ãƒ¼ãƒ‰ (æ“ä½œä¸å¯)";
            position: absolute; inset: 0; background: rgba(255,255,255,0.6);
            z-index: 50; display: flex; align-items: center; justify-content: center;
            font-weight: bold; color: #4a5568; font-size: 16px; text-shadow: 0 1px 2px white;
            pointer-events: all;
        }

        /* --- Bottom Nav --- */
        .bottom-nav {
            background: white; border-top: 1px solid #e2e8f0;
            height: 60px; padding-bottom: env(safe-area-inset-bottom, 0);
            display: grid; grid-template-columns: repeat(4, 1fr);
            flex-shrink: 0; z-index: 100;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #a0aec0; font-size: 10px; font-weight: bold; transition: 0.2s;
        }
        .nav-item.active { color: #3182ce; background: #ebf8ff; }
        .nav-icon { font-size: 20px; margin-bottom: 2px; }

        /* --- Components --- */
        .section-title {
            font-size: 14px; font-weight: bold; color: #2d3748;
            border-left: 4px solid #3182ce; padding-left: 8px; margin: 15px 0 10px 0;
            display: flex; align-items: center; justify-content: space-between;
        }

        /* Inventory Table */
        .stock-table { width: 100%; border-collapse: separate; border-spacing: 0 8px; margin-bottom: 10px; }
        .stock-table th { color: #4a5568; padding: 2px; font-size: 10px; text-align: center; }
        .stock-table td { padding: 0 4px; }
        
        .stock-display-btn {
            width: 100%; padding: 12px 0; text-align: center; 
            font-size: 18px; font-weight: bold; color: #2d3748; font-family: monospace;
            background: white; border: 1px solid #cbd5e0; border-radius: 8px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .stock-display-btn.editable { color: #3182ce; border-color: #3182ce; background: #ebf8ff; cursor: pointer; }
        .stock-display-btn:active.editable { background: #bee3f8; }

        /* Picker Overlay */
        #pickerModal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 3000;
            display: none; align-items: flex-end; opacity: 0; transition: opacity 0.2s;
        }
        #pickerModal.show { display: flex; opacity: 1; }
        
        .picker-sheet {
            background: white; width: 100%; border-radius: 16px 16px 0 0;
            padding-bottom: env(safe-area-inset-bottom);
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.1, 0.7, 0.1, 1);
        }
        #pickerModal.show .picker-sheet { transform: translateY(0); }

        .picker-toolbar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 15px; border-bottom: 1px solid #edf2f7; background: #f7fafc; border-radius: 16px 16px 0 0;
        }
        .picker-title { font-weight: bold; font-size: 14px; color: #4a5568; }
        
        .picker-wheel-container {
            height: 200px; position: relative; overflow: hidden; background: white;
        }
        .picker-wheel {
            height: 100%; overflow-y: scroll; scroll-snap-type: y mandatory;
            padding: 80px 0;
        }
        .picker-wheel::-webkit-scrollbar { display: none; }
        
        .picker-item {
            height: 40px; display: flex; align-items: center; justify-content: center;
            font-size: 20px; font-weight: bold; color: #a0aec0;
            scroll-snap-align: center; transition: 0.2s;
        }
        .picker-highlight {
            position: absolute; top: 80px; left: 0; right: 0; height: 40px;
            border-top: 1px solid #e2e8f0; border-bottom: 1px solid #e2e8f0;
            pointer-events: none; background: rgba(49, 130, 206, 0.05);
        }

        /* Order Buttons */
        .mtp-btn {
            width: 100%; padding: 12px; border-radius: 8px; border: none; color: white;
            text-align: left; margin-bottom: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative; overflow: hidden; transition: transform 0.1s;
        }
        .mtp-btn:active { transform: scale(0.98); }
        .mtp-btn-1 { background: linear-gradient(135deg, #e53e3e 0%, #9b2c2c 100%); }
        .mtp-btn-2 { background: linear-gradient(135deg, #3182ce 0%, #2c5282 100%); }
        .mtp-head { font-size: 16px; font-weight: 900; display: block; margin-bottom: 2px; }
        .mtp-sub { font-size: 11px; opacity: 0.9; }

        /* Doc Grid */
        .doc-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-bottom: 10px; }
        .doc-btn {
            padding: 8px 2px; border: 1px solid #cbd5e0; border-radius: 6px; background: white;
            font-size: 11px; font-weight: bold; color: #4a5568; text-align: center;
            min-height: 44px; display: flex; align-items: center; justify-content: center;
            flex-direction: column; line-height: 1.2; transition: 0.1s;
        }
        .doc-btn:active { background: #ebf8ff; }
        .doc-btn.active-on { color: white; border-color: transparent; box-shadow: inset 0 2px 4px rgba(0,0,0,0.2); }
        
        .bg-warn { background: #c05621 !important; }
        .bg-blood { background: #805ad5 !important; }
        .bg-med { background: #319795 !important; }
        .bg-ce { background: #d69e2e !important; }

        /* Box Cards */
        .box-card { background: white; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 10px; overflow: hidden; border-left: 4px solid #cbd5e0; }
        .box-card.active { border-left-color: #3182ce; background: #f7fcff; }
        .box-header { 
            padding: 8px 10px; background: rgba(0,0,0,0.02); border-bottom: 1px solid #edf2f7; 
            display: flex; justify-content: space-between; align-items: center; 
        }
        .box-title { font-weight: bold; font-size: 14px; color: #2d3748; }
        .item-row { 
            display: grid; grid-template-columns: 3fr 2fr 2fr; gap: 5px; 
            padding: 8px 10px; border-bottom: 1px solid #f0f0f0; align-items: center; font-size: 12px; 
        }
        .st-badge { font-size: 10px; padding: 2px 6px; border-radius: 10px; text-align: center; background: #edf2f7; color: #718096; white-space: nowrap; }
        
        /* Status Colors */
        .st-preparing { background: #feebc8; color: #c05621; }
        .st-shipped { background: #bee3f8; color: #2b6cb0; }
        .st-arrived { background: #c6f6d5; color: #2f855a; }
        .st-infusing { background: #2b6cb0; color: white; animation: pulse 1.5s infinite; }
        .st-completed { background: #2d3748; color: white; }

        /* Utils */
        .btn { padding: 6px 12px; border-radius: 4px; border: none; font-weight: bold; font-size: 12px; color: white; cursor: pointer; }
        .btn-sm { padding: 4px 8px; font-size: 10px; }
        .btn-primary { background: #3182ce; } .btn-danger { background: #e53e3e; }
        .btn-success { background: #38a169; } .btn-warn { background: #dd6b20; }
        .btn-outline { background: transparent; border: 1px solid #cbd5e0; color: #4a5568; }

        /* Log & Chat */
        .log-container { display: flex; flex-direction: column; gap: 6px; padding-bottom: 60px; }
        .log-item { font-size: 12px; padding: 5px 0; border-bottom: 1px solid #eee; }
        .log-time { color: #a0aec0; font-size: 10px; margin-right: 4px; }
        
        #chatOverlay { position: fixed; bottom: 60px; left:0; width:100%; background:white; border-top:1px solid #e2e8f0; padding:8px; z-index:90; display:none; padding-bottom: calc(8px + env(safe-area-inset-bottom)); }
        
        /* Modal - Z-INDEX 2000 */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-card { background: white; border-radius: 12px; width: 100%; max-width: 480px; padding: 20px; max-height: 90vh; overflow-y: auto; }
        .role-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 15px; }
        .role-btn { 
            border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px; text-align: center; 
            font-size: 12px; font-weight: bold; color: #4a5568; display: flex; flex-direction: column; gap: 4px; 
        }
        .role-btn:active { background: #ebf8ff; border-color: #3182ce; color: #2b6cb0; }

        /* Blood Big Display */
        .blood-big { background: #e53e3e; color: white; text-align: center; padding: 10px; border-radius: 8px; margin-bottom: 15px; display: none; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .blood-big.show { display: block; animation: fadeIn 0.5s; }

        /* Full Screen Popup */
        .blood-popup { display: none; position: fixed; inset: 0; background: rgba(229, 62, 62, 0.95); z-index: 3000; justify-content: center; align-items: center; flex-direction: column; color: white; animation: flashIn 0.3s; pointer-events: none; }
        .blood-popup h1 { font-size: 24px; margin-bottom: 10px; letter-spacing: 2px; border-bottom: 2px solid white; padding-bottom: 5px; }
        .blood-popup div { font-size: 60px; font-weight: 800; text-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .blood-popup.active { display: flex; }

        .hidden { display: none !important; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes flashIn { 0% { opacity: 0; transform: scale(0.9); } 50% { opacity: 1; transform: scale(1.05); } 100% { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>

    <div id="pickerModal">
        <div class="picker-sheet">
            <div class="picker-toolbar">
                <div class="picker-title" id="pickerTitle">RBC (Aå‹)</div>
                <button class="btn btn-primary" onclick="confirmPicker()">å®Œäº†</button>
            </div>
            <div class="picker-wheel-container">
                <div class="picker-highlight"></div>
                <div class="picker-wheel" id="pickerWheel">
                    </div>
            </div>
        </div>
    </div>

    <div id="bloodPopup" class="blood-popup">
        <h1>ğŸ©¸ è¡€æ¶²å‹ç¢ºå®š ğŸ©¸</h1>
        <div id="bloodPopupText">A Rh(+)</div>
    </div>

    <div id="loginModal" class="modal active">
        <div class="modal-card">
            <h2 style="text-align:center; font-size:18px; margin-bottom:5px;">MTP Cloud</h2>
            <p style="text-align:center; font-size:11px; color:#718096;">å½¹å‰²ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
            
            <div id="stepRole">
                <div class="role-grid">
                    <div class="role-btn" onclick="selectRole('ãƒ‡ãƒ¼ã‚¿ç®¡ç†è€…')" style="grid-column: span 2; background:#ebf8ff; border-color:#3182ce;">
                        <span style="font-size:20px;">ğŸ“Š</span>ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…<br><span style="font-size:10px;">ãƒ­ã‚°ç¢ºèª</span>
                    </div>
                    <div class="role-btn" onclick="selectRole('è¼¸è¡€æ¤œæŸ»éƒ¨')"><span style="font-size:20px;">ğŸ¥</span>è¼¸è¡€æ¤œæŸ»éƒ¨<br><span style="font-size:10px;">åœ¨åº«ç®¡ç†</span></div>
                    <div class="role-btn" onclick="selectRole('ãƒãƒ¼ãƒ ãƒªãƒ¼ãƒ€ãƒ¼')"><span style="font-size:20px;">ğŸ‘¨â€âš•ï¸</span>ãƒãƒ¼ãƒ ãƒªãƒ¼ãƒ€ãƒ¼<br><span style="font-size:10px;">åŒ»å¸«</span></div>
                    <div class="role-btn" onclick="selectRole('è¼¸è¡€è²¬ä»»è€…')"><span style="font-size:20px;">ğŸ“‹</span>è¼¸è¡€è²¬ä»»è€…<br><span style="font-size:10px;">åŒ»å¸«</span></div>
                    <div class="role-btn" onclick="selectRole('æ‰‹æŠ€åŒ»å¸«')"><span style="font-size:20px;">ğŸ’‰</span>æ‰‹æŠ€åŒ»å¸«</div>
                    <div class="role-btn" onclick="selectRole('è¨˜éŒ²Ns')"><span style="font-size:20px;">ğŸ“</span>è¨˜éŒ²Ns</div>
                    <div class="role-btn" onclick="selectRole('ä»‹åŠ©Ns')"><span style="font-size:20px;">ğŸ’Š</span>ä»‹åŠ©Ns</div>
                    <div class="role-btn" onclick="selectRole('MTPæ¬é€è€…')"><span style="font-size:20px;">ğŸƒ</span>MTPæ¬é€è€…</div>
                    <div class="role-btn" onclick="selectRole('è‡¨åºŠå·¥å­¦æŠ€å¸«')"><span style="font-size:20px;">âš™ï¸</span>è‡¨åºŠå·¥å­¦æŠ€å¸«</div>
                </div>
            </div>

            <div id="stepSession" class="hidden">
                <h3 id="sessionTitle" class="section-title" style="margin-top:0;">é€²è¡Œä¸­ã®ç—‡ä¾‹</h3>
                
                <div id="adminStockPanel" class="hidden" style="background:#f0f9ff; padding:10px; border-radius:8px; border:1px solid #bee3f8; margin-bottom:15px;">
                    <div style="font-weight:bold; color:#2b6cb0; font-size:12px; margin-bottom:5px;">ğŸ“¦ é™¢å†…åœ¨åº«ãƒã‚¹ã‚¿ãƒ¼ (å³æ™‚åæ˜ )</div>
                    <div id="masterStockTableWrapper" style="overflow-x:auto;"></div>
                </div>

                <div id="researchPanel" class="hidden" style="background:#f0fff4; padding:15px; border-radius:8px; border:1px solid #9ae6b4; margin-bottom:15px; text-align:center;">
                    <h3 style="color:#276749; font-size:16px; margin-bottom:10px;">ğŸ“Š ç ”ç©¶ç”¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹</h3>
                    <p style="font-size:11px; color:#4a5568; margin-bottom:15px;">å®Œäº†ã—ãŸå…¨ç—‡ä¾‹ã®åˆ†æç”¨ãƒ‡ãƒ¼ã‚¿ã‚’<br>CSVå½¢å¼ã§ä¸€æ‹¬ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚</p>
                    <button class="btn btn-success" style="width:100%; padding:15px;" onclick="downloadAllResearchData()">ğŸ“¥ å…¨ç—‡ä¾‹ãƒ‡ãƒ¼ã‚¿ã‚’CSVå‡ºåŠ›</button>
                </div>

                <div id="sessionList" style="display:flex; flex-direction:column; gap:8px;"></div>
                
                <div id="newSessionBlock" style="margin-top:20px; padding-top:15px; border-top:1px dashed #cbd5e0;">
                    <div style="font-size:12px; font-weight:bold; margin-bottom:5px;">æ–°è¦MTPç™ºå‹•</div>
                    <div style="display:flex; gap:5px; align-items:center;">
                        <input type="text" id="newPid" class="stock-input" placeholder="ID" style="border:1px solid #cbd5e0; border-radius:4px; flex:1; text-align:left; padding-left:10px; height:44px;">
                        <select id="newLoc" style="border:1px solid #cbd5e0; border-radius:4px; width:100px; padding:5px; font-size:14px; background:white; height:44px;">
                            <option value="ER">ER</option>
                            <option value="æ•‘æ€¥ç—…æ£Ÿ">æ•‘æ€¥ç—…æ£Ÿ</option>
                            <option value="OR">OR</option>
                        </select>
                        <button class="btn btn-danger" onclick="startNewSession()">ç™ºå‹•</button>
                    </div>
                </div>
                <button class="btn btn-outline" style="width:100%; margin-top:10px;" onclick="backToRole()">æˆ»ã‚‹</button>
            </div>
        </div>
    </div>

    <header class="app-header">
        <div class="header-row">
            <div style="display:flex; align-items:baseline; gap:5px;">
                <span style="font-size:16px; font-weight:bold;">ID: <span id="hdPid">---</span></span>
                <span id="hdRole" class="role-pill">Guest</span>
            </div>
            <div id="hdStatus" class="status-badge st-standby">å¾…æ©Ÿä¸­</div>
        </div>
        
        <div class="stats-bar">
            <div class="stat-group" style="border-right:1px solid #4a5568;">
                <span class="stat-label">ğŸ“ ç¾å ´åœ¨åº« (æœªæŠ•ä¸)</span>
                <div class="stat-vals">
                    <span class="c-red">R<span id="sRBC">0</span></span>
                    <span class="c-yel">F<span id="sFFP">0</span></span>
                    <span class="c-blu">P<span id="sPC">0</span></span>
                </div>
            </div>
            <div class="stat-group">
                <span class="stat-label">ğŸ’‰ å®Ÿæ–½è¼¸è¡€é‡ (å®Œäº†)</span>
                <div class="stat-vals">
                    <span class="c-red">R<span id="uRBC">0</span></span>
                    <span class="c-yel">F<span id="uFFP">0</span></span>
                    <span class="c-blu">P<span id="uPC">0</span></span>
                </div>
            </div>
        </div>
    </header>

    <div class="main-viewport" id="mainViewport">
        
        <div id="tabInventory" class="tab-view">
            <div class="section-title">
                ğŸ¥ é™¢å†…åœ¨åº«ãƒã‚¹ã‚¿ãƒ¼
                <span id="stockModeLabel" style="font-size:10px; font-weight:normal; color:#718096;">é–²è¦§ã®ã¿</span>
            </div>
            <div id="viewStockTableWrapper"></div>
            <p style="font-size:10px; color:#718096; margin-top:5px;">â€»è¼¸è¡€æ¤œæŸ»éƒ¨ã®ã¿ç·¨é›†å¯èƒ½ã€‚ã‚¿ãƒƒãƒ—ã—ã¦ãƒ€ã‚¤ãƒ¤ãƒ«ã§å¤‰æ›´ã€‚</p>
        </div>

        <div id="tabAction" class="tab-view active-view">
            
            <div id="bloodBig" class="blood-big">
                <div style="font-size:10px; opacity:0.8;">BLOOD TYPE CONFIRMED</div>
                <div id="bloodBigText" style="font-size:36px; font-weight:900;"></div>
            </div>

            <div id="panelDoctor">
                <div class="section-title">âš¡ ã‚ªãƒ¼ãƒ€ãƒ¼</div>
                <button class="mtp-btn mtp-btn-1" onclick="orderMTP(1)">
                    <span class="mtp-head">â‘  ç•°å‹é©åˆè¡€ ã‚ªãƒ¼ãƒ€ãƒ¼</span>
                    <span class="mtp-sub">BOX1: Oå‹RBC(3) + ABå‹FFP(3)</span>
                </button>
                <button class="mtp-btn mtp-btn-2" onclick="orderMTP(2)">
                    <span class="mtp-head">â‘¡ åŒå‹è¡€ ã‚ªãƒ¼ãƒ€ãƒ¼ (è¦è¡€å‹)</span>
                    <span class="mtp-sub">BOX2(åŒå‹) + BOX3(PCå«) ã‚’è¿½åŠ </span>
                </button>

                <div class="section-title">ğŸš¨ å®£è¨€ãƒ»æŒ‡ç¤º</div>
                <div class="doc-grid">
                    <div class="doc-btn" id="btnWarn" onclick="toggleFlag('warn', 'ç•°å‹è¼¸è¡€å®£è¨€', 'bg-warn')">âš ï¸ ç•°å‹è¼¸è¡€<br>å®£è¨€</div>
                    <div class="doc-btn" id="btnBlood" onclick="toggleFlag('blood', 'æ¡è¡€2å›æ¸ˆ', 'bg-blood')">ğŸ’‰ æ¡è¡€<br>2å›æ¸ˆ</div>
                    <div class="doc-btn" style="border-color:#e53e3e; color:#e53e3e;" onclick="endMTP()">ğŸ MTP<br>çµ‚äº†å®£è¨€</div>
                </div>

                <div class="section-title">ğŸ’Š è–¬å‰¤æŠ•ä¸</div>
                <div class="doc-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="doc-btn" id="btnFib" onclick="toggleMed('fib', 'ãƒ•ã‚£ãƒ–ãƒªãƒã‚²ãƒ³')">ãƒ•ã‚£ãƒ–ãƒªãƒã‚²ãƒ³</div>
                    <div class="doc-btn" id="btnTrans" onclick="toggleMed('trans', 'ãƒˆãƒ©ãƒ³ã‚µãƒŸãƒ³')">ãƒˆãƒ©ãƒ³ã‚µãƒŸãƒ³</div>
                    <div class="doc-btn" id="btnK2" onclick="toggleMed('k2', 'K2')">ã‚±ã‚¤ãƒ„ãƒ¼</div>
                    <div class="doc-btn" id="btnPrax" onclick="toggleMed('prax', 'ãƒ—ãƒªã‚ºãƒã‚¤ãƒ³ãƒ‰')">ãƒ—ãƒªã‚ºãƒã‚¤ãƒ³ãƒ‰</div>
                    <div class="doc-btn" id="btnKcentra" onclick="toggleMed('kcentra', 'ã‚±ã‚¤ã‚»ãƒ³ãƒˆãƒ©')">ã‚±ã‚¤ã‚»ãƒ³ãƒˆãƒ©</div>
                </div>
            </div>

            <div id="panelCE" class="hidden">
                <div class="section-title">âš™ï¸ MEã‚¢ã‚¯ã‚·ãƒ§ãƒ³</div>
                <div class="doc-btn" id="btnRapid" onclick="toggleFlag('rapid', 'Rapid Infuser', 'bg-ce')" style="width:100%; font-size:14px; height:50px;">âš¡ ãƒ©ãƒ”ãƒƒãƒ‰ã‚¤ãƒ³ãƒ’ãƒ¥ãƒ¼ã‚¶ãƒ¼é–‹å§‹</div>
            </div>

            <div id="panelLab" class="hidden">
                <div class="section-title">ğŸ©¸ è¡€æ¶²å‹ç¢ºå®š</div>
                <div class="doc-grid" style="grid-template-columns: repeat(4, 1fr);">
                    <div class="doc-btn" id="btnA" onclick="setBlood('A')">A</div>
                    <div class="doc-btn" id="btnB" onclick="setBlood('B')">B</div>
                    <div class="doc-btn" id="btnO" onclick="setBlood('O')">O</div>
                    <div class="doc-btn" id="btnAB" onclick="setBlood('AB')">AB</div>
                </div>
                <div class="doc-grid" style="grid-template-columns: repeat(2, 1fr);">
                    <div class="doc-btn" id="btnRhP" onclick="setRh('+')">Rh(+)</div>
                    <div class="doc-btn" id="btnRhM" onclick="setRh('-')">Rh(-)</div>
                </div>
                <div style="background:white; padding:8px; border:1px solid #cbd5e0; border-radius:6px; font-size:11px;">
                    <strong>ä¸è¦å‰‡æŠ—ä½“:</strong>
                    <button class="btn btn-sm btn-success" id="btnIrregNeg" onclick="setIrreg('neg')">ãªã—</button>
                    <button class="btn btn-sm btn-danger" id="btnIrregPos" onclick="setIrreg('pos')">ã‚ã‚Š</button>
                </div>
            </div>

            <div class="section-title">ğŸ“¦ è¼¸è¡€ãƒãƒƒã‚°çŠ¶æ³</div>
            <div id="boxesContainer"></div>

            <div style="height:40px;"></div>
            <button id="btnComplete" class="btn btn-outline" style="width:100%; margin-bottom:20px;" onclick="moveToWard()">ğŸ¥ ç—…æ£Ÿå…¥å®¤ (å®Œçµ)</button>
        </div>

        <div id="tabLog" class="tab-view">
            <div class="section-title">ğŸ’¬ ãƒãƒ£ãƒƒãƒˆãƒ»ãƒ­ã‚°</div>
            <div id="logContainer" class="log-container"></div>
        </div>

        <div id="tabSummary" class="tab-view">
            <div class="section-title">
                ğŸ“ è¨˜éŒ²ã‚µãƒãƒªãƒ¼
                <button class="btn btn-sm btn-primary" onclick="copySummary()">ã‚³ãƒ”ãƒ¼</button>
            </div>
            <textarea id="summaryText" style="width:100%; height:300px; padding:10px; font-size:11px; font-family:monospace; border:1px solid #cbd5e0; border-radius:6px;" readonly></textarea>
        </div>

    </div>

    <nav class="bottom-nav">
        <div class="nav-item" onclick="changeTab('tabInventory', this)">
            <span class="nav-icon">ğŸ“Š</span>åœ¨åº«
        </div>
        <div class="nav-item active" onclick="changeTab('tabAction', this)">
            <span class="nav-icon">âš¡</span>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
        </div>
        <div class="nav-item" onclick="changeTab('tabLog', this)">
            <span class="nav-icon">ğŸ’¬</span>ãƒ­ã‚°
        </div>
        <div class="nav-item" onclick="changeTab('tabSummary', this)">
            <span class="nav-icon">ğŸ“</span>ã‚µãƒãƒªãƒ¼
        </div>
    </nav>

    <div id="chatOverlay">
        <div style="display:flex; gap:5px; overflow-x:auto; padding-bottom:5px; margin-bottom:5px;" id="cannedArea"></div>
        <div style="display:flex; gap:5px;">
            <input type="text" id="chatInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸..." style="flex:1; padding:8px; border:1px solid #cbd5e0; border-radius:4px;">
            <button class="btn btn-primary btn-sm" onclick="sendChat()">é€ä¿¡</button>
        </div>
    </div>

    <script>
        // =================================================================
        // CONFIG
        // =================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyDdqljAVfjGzKWAA1oWsbnwIphifYMnr-E",
            authDomain: "mtp-project-c8f20.firebaseapp.com",
            projectId: "mtp-project-c8f20",
            storageBucket: "mtp-project-c8f20.firebasestorage.app",
            messagingSenderId: "48202967020",
            appId: "1:48202967020:web:626950d14dfb088200c2c9",
            measurementId: "G-QPM4YE65VH"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // =================================================================
        // STATE
        // =================================================================
        let myRole = "";
        let currentSessionId = null;
        let currentSessionData = null;
        let hospitalStock = {RBC:{A:6,B:6,O:6,AB:6},FFP:{A:6,B:6,O:6,AB:6},PC:{A:10,B:10,O:10,AB:10}};
        let lastBloodState = "";
        let unsubscribeInventory = null;
        let unsubscribeSession = null;

        // Picker State
        let pickerTarget = null; // {prod, type}
        let pickerValue = 0;

        const ROLES = {
            MANAGER: ['ç ”ç©¶ãƒ‡ãƒ¼ã‚¿ç®¡ç†è€…'],
            ADMIN: ['è¼¸è¡€æ¤œæŸ»éƒ¨'],
            LEADER: ['ãƒãƒ¼ãƒ ãƒªãƒ¼ãƒ€ãƒ¼'],
            DOCTOR: ['ãƒãƒ¼ãƒ ãƒªãƒ¼ãƒ€ãƒ¼', 'æ‰‹æŠ€åŒ»å¸«', 'è¼¸è¡€è²¬ä»»è€…'],
            NURSE: ['è¨˜éŒ²Ns', 'ä»‹åŠ©Ns'],
            CE: ['è‡¨åºŠå·¥å­¦æŠ€å¸«'],
            TRANS: ['MTPæ¬é€è€…', 'è‡¨åºŠå·¥å­¦æŠ€å¸«']
        };

        const CANNED = {
            DOCTOR: ['é–‹è…¹è¡“é–‹å§‹', 'IVRé–‹å§‹', 'ãƒã‚¤ã‚¿ãƒ«ä¸å®‰å®š', 'REBOAæŒ¿å…¥', 'æ­¢è¡€ç¢ºèª'],
            ADMIN: ['ç•°å‹å¯¾å¿œ', 'åŒå‹æœªã‚¯ãƒ­ã‚¹', 'åœ¨åº«ç¢ºèªä¸­', 'å‡ºåº«å®Œäº†'],
            NURSE: ['åˆ°ç€', 'æŠ•ä¸é–‹å§‹', 'æ€¥é€Ÿè¼¸è¡€ä¸­', 'è¡€å‹æå‡ºæ¸ˆ'],
            TRANS: ['åˆ°ç€', 'æ¬¡ã®ã‚ªãƒ¼ãƒ€ãƒ¼ä¾é ¼', 'äº†è§£']
        };

        // =================================================================
        // UI & NAVIGATION
        // =================================================================
        function selectRole(role) {
            // --- è¿½åŠ : ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³èªè¨¼ ---
            if (ROLES.MANAGER.includes(role)) {
                const id = prompt("ç®¡ç†è€…IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                if (id !== "185383") return alert("IDãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“");
                
                const pw = prompt("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                if (pw !== "Love99mtp") return alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“");
            }
            // -----------------------------

            myRole = role;
            document.getElementById('hdRole').textContent = role;
            document.getElementById('stepRole').classList.add('hidden');
            document.getElementById('stepSession').classList.remove('hidden');

            const isManager = ROLES.MANAGER.includes(role);
            const isAdmin = ROLES.ADMIN.includes(role);
            
            // Research Manager
            if(isManager) {
                document.getElementById('researchPanel').classList.remove('hidden');
                document.getElementById('sessionList').classList.add('hidden');
                document.getElementById('newSessionBlock').classList.add('hidden');
                document.getElementById('sessionTitle').textContent = "ç®¡ç†è€…ãƒ¡ãƒ‹ãƒ¥ãƒ¼";
                return; // Early return for Manager
            } else {
                document.getElementById('researchPanel').classList.add('hidden');
                document.getElementById('sessionList').classList.remove('hidden');
                document.getElementById('newSessionBlock').classList.remove('hidden');
            }

            // Inventory Admin
            if(isAdmin) {
                document.getElementById('adminStockPanel').classList.remove('hidden');
                document.getElementById('sessionTitle').textContent = "åœ¨åº«ç®¡ç† / ç—‡ä¾‹é¸æŠ";
                renderStockTable('masterStockTableWrapper', true);
            } else {
                document.getElementById('adminStockPanel').classList.add('hidden');
                document.getElementById('sessionTitle').textContent = "é€²è¡Œä¸­ã®ç—‡ä¾‹";
            }

            document.getElementById('stockModeLabel').textContent = isAdmin ? "ç·¨é›†å¯èƒ½" : "é–²è¦§ã®ã¿";
            renderStockTable('viewStockTableWrapper', isAdmin);

            startInventorySync();
            loadActiveSessions();
        }

        function backToRole() {
            document.getElementById('stepRole').classList.remove('hidden');
            document.getElementById('stepSession').classList.add('hidden');
            if(unsubscribeInventory) unsubscribeInventory();
        }

        function changeTab(tabId, navEl) {
            document.querySelectorAll('.tab-view').forEach(el => el.classList.remove('active-view'));
            document.getElementById(tabId).classList.add('active-view');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if(navEl) navEl.classList.add('active');
            
            const overlay = document.getElementById('chatOverlay');
            if(tabId === 'tabLog' && !document.getElementById('tabLog').classList.contains('read-only-overlay')) {
                overlay.style.display = 'block';
                renderCanned();
            } else {
                overlay.style.display = 'none';
            }
        }

        let touchStartX = 0;
        const viewport = document.getElementById('mainViewport');
        viewport.addEventListener('touchstart', e => touchStartX = e.changedTouches[0].screenX);
        viewport.addEventListener('touchend', e => {
            const touchEndX = e.changedTouches[0].screenX;
            if (touchEndX < touchStartX - 50) nextTab();
            if (touchEndX > touchStartX + 50) prevTab();
        });

        function nextTab() {
            const current = document.querySelector('.nav-item.active');
            if(current && current.nextElementSibling) current.nextElementSibling.click();
        }
        function prevTab() {
            const current = document.querySelector('.nav-item.active');
            if(current && current.previousElementSibling) current.previousElementSibling.click();
        }

        // =================================================================
        // INVENTORY LOGIC (DRUM PICKER)
        // =================================================================
        function renderStockTable(wrapperId, editable) {
            const el = document.getElementById(wrapperId);
            if(!el) return;
            let html = `<table class="stock-table"><thead><tr><th></th><th>A</th><th>B</th><th>O</th><th>AB</th></tr></thead><tbody>`;
            ['RBC','FFP','PC'].forEach(prod => {
                html += `<tr><td style="font-weight:bold; background:#edf2f7; text-align:center;">${prod}</td>`;
                ['A','B','O','AB'].forEach(type => {
                    const id = `inv_${wrapperId}_${prod}_${type}`;
                    const cls = editable ? 'stock-display-btn editable' : 'stock-display-btn';
                    const clickFn = editable ? `onclick="openPicker('${prod}','${type}')"` : '';
                    html += `<td><div id="${id}" class="${cls}" ${clickFn}>-</div></td>`;
                });
                html += `</tr>`;
            });
            html += `</tbody></table>`;
            el.innerHTML = html;
        }

        function startInventorySync() {
            unsubscribeInventory = db.collection("master").doc("inventory").onSnapshot(doc => {
                if(doc.exists) {
                    hospitalStock = doc.data();
                } else {
                    hospitalStock = {RBC:{A:6,B:6,O:6,AB:6},FFP:{A:6,B:6,O:6,AB:6},PC:{A:10,B:10,O:10,AB:10}};
                    db.collection("master").doc("inventory").set(hospitalStock);
                }
                updateAllStockDisplays();
            });
        }

        function updateAllStockDisplays() {
            ['masterStockTableWrapper', 'viewStockTableWrapper'].forEach(wId => {
                if(document.getElementById(wId)) {
                    ['RBC','FFP','PC'].forEach(p => {
                        ['A','B','O','AB'].forEach(t => {
                            const el = document.getElementById(`inv_${wId}_${p}_${t}`);
                            if(el) {
                                const val = (hospitalStock[p] && hospitalStock[p][t] !== undefined) ? hospitalStock[p][t] : (p==='PC'?10:6);
                                el.textContent = val;
                            }
                        });
                    });
                }
            });
        }

        function openPicker(prod, type) {
            pickerTarget = {prod, type};
            const currentVal = (hospitalStock[prod] && hospitalStock[prod][type] !== undefined) ? hospitalStock[prod][type] : (prod==='PC'?10:6);
            document.getElementById('pickerTitle').textContent = `${prod} (${type}å‹) æ•°é‡å¤‰æ›´`;
            const wheel = document.getElementById('pickerWheel');
            let html = "";
            const step = (prod === 'PC') ? 10 : 2;
            const max = (prod === 'PC') ? 200 : 100;
            for(let i=0; i<=max; i+=step) {
                html += `<div class="picker-item" data-val="${i}">${i}</div>`;
            }
            wheel.innerHTML = html;
            document.getElementById('pickerModal').classList.add('show');
            setTimeout(() => {
                const targetIndex = currentVal / step;
                wheel.scrollTop = targetIndex * 40;
            }, 10);
        }

        function confirmPicker() {
            if(!pickerTarget) return;
            const wheel = document.getElementById('pickerWheel');
            const index = Math.round(wheel.scrollTop / 40);
            const step = (pickerTarget.prod === 'PC') ? 10 : 2;
            const newVal = index * step;
            db.collection("master").doc("inventory").update({
                [`${pickerTarget.prod}.${pickerTarget.type}`]: newVal
            });
            closePicker();
        }

        function closePicker() {
            document.getElementById('pickerModal').classList.remove('show');
            pickerTarget = null;
        }

        // =================================================================
        // SESSION LOGIC
        // =================================================================
        function loadActiveSessions() {
            const list = document.getElementById('sessionList');
            // Load ALL sessions
            db.collection("mtp_sessions").orderBy("start_time", "desc").limit(20).onSnapshot(snap => {
                if(snap.empty) { list.innerHTML = "<div style='text-align:center; padding:20px; color:#a0aec0;'>ãªã—</div>"; return; }
                list.innerHTML = snap.docs.map(doc => {
                    const d = doc.data();
                    const isCompleted = d.status === 'completed';
                    const delBtn = ROLES.LEADER.includes(myRole) ? `<button class="btn btn-sm btn-outline" style="color:#e53e3e; border-color:#e53e3e;" onclick="deleteSession('${doc.id}', event)">å‰Šé™¤</button>` : '';
                    
                    const statusText = isCompleted ? "ã€å®Œäº†ã€‘å±¥æ­´" : "é€²è¡Œä¸­";
                    const statusStyle = isCompleted ? "color:#718096; background:#edf2f7;" : "color:#3182ce; background:#ebf8ff;";
                    const btnText = isCompleted ? "å‚ç…§" : "å‚åŠ ";
                    
                    return `
                    <div class="session-item" style="background:#fff; border:1px solid #cbd5e0; padding:10px; border-radius:8px; display:flex; justify-content:space-between; align-items:center;" onclick="joinSession('${doc.id}')">
                        <div>
                            <div style="font-weight:bold; font-size:16px;">${d.id} <span style="font-size:10px; padding:2px 4px; border-radius:4px; ${statusStyle}">${statusText}</span></div>
                            <div style="font-size:11px; color:#718096;">${d.location} (${d.start_time})</div>
                        </div>
                        <div style="display:flex; gap:5px;">${delBtn}<button class="btn btn-sm btn-primary">${btnText}</button></div>
                    </div>`;
                }).join("");
            });
        }

        function startNewSession() {
            const pid = document.getElementById('newPid').value.trim();
            const loc = document.getElementById('newLoc').value;
            if(!pid) return alert("IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            db.collection("mtp_sessions").doc(pid).set({
                id: pid, location: loc, status: 'active',
                start_time: new Date().toLocaleTimeString('ja-JP', {hour:'2-digit', minute:'2-digit'}),
                boxes: [], logs: [], chats: [],
                used: {RBC:0, FFP:0, PC:0},
                blood_res: {abo:'', rh:'', irreg:'neg'},
                flags: {}, meds: {}
            }).then(() => joinSession(pid));
        }

        function deleteSession(id, e) {
            e.stopPropagation();
            if(confirm("æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿå¾©å…ƒã§ãã¾ã›ã‚“ã€‚")) db.collection("mtp_sessions").doc(id).delete();
        }

        function joinSession(id) {
            currentSessionId = id;
            document.getElementById('hdPid').textContent = id;
            document.getElementById('loginModal').classList.remove('active');
            
            const isDoc = ROLES.DOCTOR.includes(myRole);
            const isCE = ROLES.CE.includes(myRole);
            const isAdmin = ROLES.ADMIN.includes(myRole);

            if(!isDoc) document.getElementById('panelDoctor').classList.add('hidden');
            if(isCE) document.getElementById('panelCE').classList.remove('hidden');
            if(isAdmin) document.getElementById('panelLab').classList.remove('hidden');

            unsubscribeSession = db.collection("mtp_sessions").doc(id).onSnapshot(doc => {
                if(!doc.exists) { alert("ç—‡ä¾‹ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸ"); location.reload(); return; }
                currentSessionData = doc.data();
                renderScreen(currentSessionData);
            });
        }

        // =================================================================
        // RENDERING & ACTIONS
        // =================================================================
        function renderScreen(data) {
            const isReadOnly = data.status === 'completed';
            
            // Set Read Only Overlay
            if(isReadOnly) {
                document.getElementById('tabAction').classList.add('read-only-overlay');
                document.getElementById('tabInventory').classList.add('read-only-overlay');
                document.getElementById('chatOverlay').style.display = 'none';
                document.getElementById('btnComplete').style.display = 'none';
                document.getElementById('hdStatus').textContent = "å®Œäº† (å‚ç…§)";
                document.getElementById('hdStatus').className = "status-badge st-completed";
            } else {
                document.getElementById('tabAction').classList.remove('read-only-overlay');
                document.getElementById('tabInventory').classList.remove('read-only-overlay');
                if(document.getElementById('tabLog').classList.contains('active-view')) document.getElementById('chatOverlay').style.display = 'block';
                document.getElementById('btnComplete').style.display = 'block';
                const sb = document.getElementById('hdStatus');
                sb.className = `status-badge st-${data.status}`;
                sb.textContent = data.status==='active' ? 'ç™ºå‹•ä¸­' : 'çµ‚äº†';
            }

            document.getElementById('uRBC').textContent = data.used.RBC;
            document.getElementById('uFFP').textContent = data.used.FFP;
            document.getElementById('uPC').textContent = data.used.PC;

            let s = {RBC:0, FFP:0, PC:0};
            data.boxes.forEach(b => {
                b.items.forEach(i => {
                    if(i.status === 'arrived') {
                        if(i.type.includes('RBC')) s.RBC += i.units;
                        else if(i.type.includes('FFP')) s.FFP += i.units;
                        else if(i.type.includes('PC')) s.PC += i.units;
                    }
                });
            });
            document.getElementById('sRBC').textContent = s.RBC;
            document.getElementById('sFFP').textContent = s.FFP;
            document.getElementById('sPC').textContent = s.PC;

            // Blood Popup Logic
            const currentBlood = `${data.blood_res.abo} Rh(${data.blood_res.rh})`;
            if(lastBloodState !== "" && lastBloodState !== currentBlood && data.blood_res.abo) {
                document.getElementById('bloodPopupText').textContent = currentBlood;
                const pop = document.getElementById('bloodPopup');
                pop.classList.remove('active');
                void pop.offsetWidth; // trigger reflow
                pop.classList.add('active');
                setTimeout(()=>pop.classList.remove('active'), 3000);
            }
            lastBloodState = currentBlood;

            const bb = document.getElementById('bloodBig');
            if(data.blood_res && data.blood_res.abo) {
                bb.classList.add('show');
                document.getElementById('bloodBigText').textContent = currentBlood;
            }

            const bc = document.getElementById('boxesContainer');
            bc.innerHTML = data.boxes.map((b, bIdx) => {
                let batchHtml = "";
                const allPending = b.items.every(i => i.status === 'pending');
                const hasPrep = b.items.some(i => i.status === 'preparing');
                const hasShipped = b.items.some(i => i.status === 'shipped');

                if(!isReadOnly) {
                    if(ROLES.ADMIN.includes(myRole)) {
                        if(allPending) batchHtml = `<button class="btn btn-sm btn-warn" onclick="batchAction(${bIdx}, 'preparing')">ä¸€æ‹¬æº–å‚™</button>`;
                        else if(hasPrep) batchHtml = `<button class="btn btn-sm btn-primary" onclick="batchAction(${bIdx}, 'shipped')">ä¸€æ‹¬å‡ºåº«</button>`;
                    }
                    if(ROLES.NURSE.includes(myRole) || ROLES.TRANS.includes(myRole)) {
                        if(hasShipped) batchHtml = `<button class="btn btn-sm btn-success" onclick="batchAction(${bIdx}, 'arrived')">ä¸€æ‹¬åˆ°ç€</button>`;
                    }
                }

                const rows = b.items.map((i, iIdx) => {
                    let btn = "";
                    if(!isReadOnly) {
                        if(ROLES.ADMIN.includes(myRole)) {
                            if(i.status==='pending') btn = `<button class="btn btn-sm btn-outline" onclick="updateItem(${bIdx},${iIdx},'preparing')">æº–å‚™</button>`;
                            else if(i.status==='preparing') btn = `<button class="btn btn-sm btn-primary" onclick="updateItem(${bIdx},${iIdx},'shipped')">å‡ºåº«</button>`;
                        }
                        if(ROLES.NURSE.includes(myRole) || ROLES.TRANS.includes(myRole) || ROLES.CE.includes(myRole)) {
                            if(i.status==='shipped') btn = `<button class="btn btn-sm btn-success" onclick="updateItem(${bIdx},${iIdx},'arrived')">åˆ°ç€</button>`;
                            else if(i.status==='arrived') btn = `<button class="btn btn-sm btn-primary" onclick="updateItem(${bIdx},${iIdx},'infusing')">é–‹å§‹</button>`;
                            else if(i.status==='infusing') btn = `<button class="btn btn-sm btn-outline" onclick="updateItem(${bIdx},${iIdx},'completed')">å®Œäº†</button>`;
                        }
                    }
                    return `
                    <div class="item-row">
                        <div>${i.type} (${i.units}U)</div>
                        <div class="st-badge st-${i.status}">${i.status}</div>
                        <div style="text-align:right;">${btn}</div>
                    </div>`;
                }).join("");

                return `
                <div class="box-card ${b.items.every(x=>x.status==='completed')?'':'active'}">
                    <div class="box-header">
                        <span class="box-title">ğŸ“¦ ${b.name}</span>
                        <div>${batchHtml}</div>
                    </div>
                    ${rows}
                </div>`;
            }).join("");

            const logs = [...(data.logs||[]), ...(data.chats||[])].sort((a,b) => a.t > b.t ? 1 : -1);
            document.getElementById('logContainer').innerHTML = logs.slice().reverse().map(l => 
                `<div class="log-item"><span class="log-time">${l.t}</span> <strong>${l.r}:</strong> ${l.m}</div>`
            ).join("");

            updateFlag('btnWarn', data.flags?.warn, 'bg-warn');
            updateFlag('btnBlood', data.flags?.blood, 'bg-blood');
            updateFlag('btnRapid', data.flags?.rapid, 'bg-ce');
            ['fib','trans','k2','prax','kcentra'].forEach(k => updateFlag('btn'+k.charAt(0).toUpperCase()+k.slice(1), data.meds?.[k], 'bg-med'));

            let sum = `ã€MTPè¨˜éŒ² ID:${data.id}ã€‘${data.location}\n`;
            sum += `ç·æŠ•ä¸: RBC${data.used.RBC} / FFP${data.used.FFP} / PC${data.used.PC}\n`;
            if(data.blood_res.abo) sum += `è¡€æ¶²å‹: ${data.blood_res.abo}å‹ Rh(${data.blood_res.rh})\n`;
            sum += `\n--- ãƒ­ã‚° ---\n`;
            logs.forEach(l => sum += `[${l.t}] ${l.m}\n`);
            document.getElementById('summaryText').value = sum;
        }

        function updateFlag(id, isActive, bgClass) {
            const el = document.getElementById(id);
            if(!el) return;
            if(isActive) { el.classList.add('active-on', bgClass); } 
            else { el.classList.remove('active-on', bgClass); }
        }

        // --- Logic ---
        function orderMTP(type) {
            if (type === 2) {
                if (!currentSessionData.blood_res || !currentSessionData.blood_res.abo) {
                    return alert("âš ï¸ è¡€æ¶²å‹ãŒç¢ºå®šã—ã¦ã„ã¾ã›ã‚“ã€‚\nå…ˆã«è¼¸è¡€æ¤œæŸ»éƒ¨ã«ã‚ˆã‚‹è¡€æ¶²å‹ï¼ˆABO/Rhï¼‰ã®ç¢ºå®šãŒå¿…è¦ã§ã™ã€‚");
                }
            }

            const currentBoxes = currentSessionData.boxes || [];
            let newBoxes = [];
            let logMsg = "";

            if(type===1) {
                const count = currentBoxes.filter(b => b.name.startsWith("BOX1")).length + 1;
                const name = `BOX1-${count} (ç•°å‹)`;
                const items = [
                    {type:'O_RBC', units:2, status:'pending'}, {type:'O_RBC', units:2, status:'pending'}, {type:'O_RBC', units:2, status:'pending'},
                    {type:'AB_FFP', units:2, status:'pending'}, {type:'AB_FFP', units:2, status:'pending'}, {type:'AB_FFP', units:2, status:'pending'}
                ];
                newBoxes.push({ name: name, items: items });
                logMsg = `ğŸ“¦ ã‚ªãƒ¼ãƒ€ãƒ¼â‘  (${name}) æŒ‡ç¤º`;
            } else {
                const abo = currentSessionData.blood_res.abo || 'O';
                const count2 = currentBoxes.filter(b => b.name.startsWith("BOX2")).length + 1;
                const count3 = currentBoxes.filter(b => b.name.startsWith("BOX3")).length + 1;

                const name2 = `BOX2-${count2} (åŒå‹)`;
                const items2 = [
                    {type:abo+'_RBC', units:2, status:'pending'}, {type:abo+'_RBC', units:2, status:'pending'},
                    {type:abo+'_FFP', units:2, status:'pending'}, {type:abo+'_FFP', units:2, status:'pending'}
                ];
                newBoxes.push({ name: name2, items: items2 });

                const name3 = `BOX3-${count3} (PCå«)`;
                const items3 = [
                    {type:abo+'_RBC', units:2, status:'pending'}, 
                    {type:abo+'_FFP', units:2, status:'pending'},
                    {type:abo+'_PC', units:10, status:'pending'}, {type:abo+'_PC', units:10, status:'pending'}
                ];
                newBoxes.push({ name: name3, items: items3 });
                logMsg = `ğŸ“¦ ã‚ªãƒ¼ãƒ€ãƒ¼â‘¡ (${name2} + ${name3}) æŒ‡ç¤º`;
            }
            
            db.collection("mtp_sessions").doc(currentSessionId).update({
                boxes: firebase.firestore.FieldValue.arrayUnion(...newBoxes),
                logs: firebase.firestore.FieldValue.arrayUnion({t:getTime(), r:myRole, m:logMsg})
            });
        }

        function updateItem(bIdx, iIdx, nextSt) {
            const ref = db.collection("mtp_sessions").doc(currentSessionId);
            db.runTransaction(async t => {
                const doc = await t.get(ref);
                const d = doc.data();
                const item = d.boxes[bIdx].items[iIdx];
                
                if(nextSt === 'shipped' && item.status !== 'shipped') {
                    let p = item.type.includes('RBC')?'RBC':item.type.includes('FFP')?'FFP':'PC';
                    let ty = item.type.split('_')[0] || 'O';
                    db.collection("master").doc("inventory").update({ [`${p}.${ty}`]: firebase.firestore.FieldValue.increment(-item.units) });
                }
                if(nextSt === 'completed') {
                    let p = item.type.includes('RBC')?'RBC':item.type.includes('FFP')?'FFP':'PC';
                    t.update(ref, { [`used.${p}`]: firebase.firestore.FieldValue.increment(item.units) });
                }
                item.status = nextSt;
                t.update(ref, { boxes: d.boxes });
            });
        }

        function batchAction(bIdx, nextSt) {
            if(!confirm("ä¸€æ‹¬æ“ä½œã—ã¾ã™ã‹ï¼Ÿ")) return;
            const ref = db.collection("mtp_sessions").doc(currentSessionId);
            db.runTransaction(async t => {
                const doc = await t.get(ref);
                const d = doc.data();
                const box = d.boxes[bIdx];
                let count = 0;
                
                box.items.forEach(i => {
                    let doUp = false;
                    if(nextSt==='preparing' && i.status==='pending') doUp=true;
                    if(nextSt==='shipped' && i.status==='preparing') {
                        let p = i.type.includes('RBC')?'RBC':i.type.includes('FFP')?'FFP':'PC';
                        let ty = i.type.split('_')[0] || 'O';
                        db.collection("master").doc("inventory").update({ [`${p}.${ty}`]: firebase.firestore.FieldValue.increment(-i.units) });
                        doUp=true;
                    }
                    if(nextSt==='arrived' && i.status==='shipped') doUp=true;

                    if(doUp) { i.status = nextSt; count++; }
                });
                if(count>0) {
                    t.update(ref, { boxes: d.boxes, logs: firebase.firestore.FieldValue.arrayUnion({t:getTime(), r:myRole, m:`${box.name} ä¸€æ‹¬${nextSt} (${count})`}) });
                }
            });
        }

        function toggleFlag(k, msg, bgClass) {
            const v = !currentSessionData.flags?.[k];
            db.collection("mtp_sessions").doc(currentSessionId).update({
                [`flags.${k}`]: v,
                logs: firebase.firestore.FieldValue.arrayUnion({t:getTime(), r:myRole, m:`${msg} ${v?'ON':'OFF'}`})
            });
        }
        function toggleMed(k, msg) {
            const v = !currentSessionData.meds?.[k];
            db.collection("mtp_sessions").doc(currentSessionId).update({
                [`meds.${k}`]: v,
                logs: firebase.firestore.FieldValue.arrayUnion({t:getTime(), r:myRole, m:`æŠ•ä¸æŒ‡ç¤º: ${msg} ${v?'ON':'OFF'}`})
            });
        }
        
        function setBlood(val) {
            if(!ROLES.ADMIN.includes(myRole)) return;
            if(currentSessionData.blood_res.abo !== val) {
                db.collection("mtp_sessions").doc(currentSessionId).update({ 'blood_res.abo': val });
            }
        }
        function setRh(val) {
            if(!ROLES.ADMIN.includes(myRole)) return;
            const v = val==='+'?'+':'-';
            if(currentSessionData.blood_res.rh !== v) {
                db.collection("mtp_sessions").doc(currentSessionId).update({ 'blood_res.rh': v });
            }
        }
        function setIrreg(val) {
            if(!ROLES.ADMIN.includes(myRole)) return;
            db.collection("mtp_sessions").doc(currentSessionId).update({ 'blood_res.irreg': val });
        }

        function endMTP() {
            if(confirm("çµ‚äº†å®£è¨€ã—ã¾ã™ã‹ï¼Ÿ")) {
                db.collection("mtp_sessions").doc(currentSessionId).update({ status: 'ended' });
            }
        }
        
        // --- COMPLETION & RESEARCH LOGGING ---
        function moveToWard() {
            if(confirm("ç—…æ£Ÿå…¥å®¤ã¨ã—ã¦ç—‡ä¾‹ã‚’å®Œçµã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆãƒ‡ãƒ¼ã‚¿ã¯ç ”ç©¶ç”¨DBã«è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™ï¼‰")) {
                const now = new Date();
                const d = currentSessionData;
                
                // Calc Params
                const findTime = (key) => { const f = d.logs.find(l=>l.m.includes(key)); return f?f.t:""; };
                const extractedData = {
                    id: d.id,
                    location: d.location,
                    date: now.toLocaleDateString(),
                    startTime: d.start_time,
                    endTime: now.toLocaleTimeString('ja-JP', {hour:'2-digit', minute:'2-digit'}),
                    totalRBC: d.used.RBC,
                    totalFFP: d.used.FFP,
                    totalPC: d.used.PC,
                    bloodType: `${d.blood_res.abo} ${d.blood_res.rh}`,
                    firstOrder: findTime("ã‚ªãƒ¼ãƒ€ãƒ¼"),
                    firstShip: findTime("å‡ºåº«"),
                    firstArrive: findTime("åˆ°ç€")
                };

                // 1. Save to Research DB
                db.collection("research_logs").doc(d.id).set(extractedData);

                // 2. Mark session as completed
                db.collection("mtp_sessions").doc(currentSessionId).update({ status: 'completed' })
                .then(() => {
                    alert("å®Œäº†ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿ã¯ä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚");
                    location.reload();
                });
            }
        }

        // --- ADMIN DOWNLOAD ---
        function downloadAllResearchData() {
            db.collection("research_logs").get().then(snap => {
                if(snap.empty) { alert("ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“"); return; }
                
                let csv = "ID,Location,Date,Start,End,RBC,FFP,PC,BloodType,FirstOrder,FirstShip,FirstArrive\n";
                snap.forEach(doc => {
                    const d = doc.data();
                    csv += `${d.id},${d.location},${d.date},${d.startTime},${d.endTime},${d.totalRBC},${d.totalFFP},${d.totalPC},${d.bloodType},${d.firstOrder},${d.firstShip},${d.firstArrive}\n`;
                });
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `MTP_Research_Data_${new Date().toLocaleDateString()}.csv`;
                a.click();
            });
        }

        function sendChat() {
            const t = document.getElementById('chatInput').value;
            if(!t) return;
            db.collection("mtp_sessions").doc(currentSessionId).update({
                chats: firebase.firestore.FieldValue.arrayUnion({t:getTime(), r:myRole, m:t})
            });
            document.getElementById('chatInput').value = "";
        }
        
        function renderCanned() {
            let list = CANNED.DOCTOR;
            if(ROLES.ADMIN.includes(myRole)) list = CANNED.ADMIN;
            if(ROLES.NURSE.includes(myRole)) list = CANNED.NURSE;
            if(ROLES.TRANS.includes(myRole)) list = CANNED.TRANS;
            document.getElementById('cannedArea').innerHTML = list.map(c => 
                `<div class="canned-btn" onclick="document.getElementById('chatInput').value='${c}';sendChat()">${c}</div>`
            ).join("");
        }

        function copySummary() {
            document.getElementById('summaryText').select();
            document.execCommand('copy');
            alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
        }
        function getTime() { return new Date().toLocaleTimeString('ja-JP', {hour:'2-digit', minute:'2-digit'}); }
    </script>
</body>
</html>

