<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MTP Cloud Mobile Ver.28.2</title>
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        /* --- åŸºæœ¬è¨­å®š --- */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Hiragino Sans", "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif; 
            background: #f0f2f5; 
            height: 100vh; /* ã‚¹ãƒãƒ›ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼å¯¾ç­– */
            height: 100dvh; 
            color: #2d3748; 
            overflow: hidden; 
        }
        
        .container { 
            width: 100%; 
            height: 100%; 
            background: white; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden;
        }
        
        /* --- ãƒ˜ãƒƒãƒ€ãƒ¼ (ã‚¹ãƒãƒ›å¯¾å¿œ) --- */
        .header { 
            background: #1a202c; 
            color: white; 
            padding: 10px 15px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 3px solid #e53e3e; 
            flex-shrink: 0; 
            z-index: 10;
        }
        .header h1 { font-size: 16px; font-weight: bold; }
        .header-info { display: flex; gap: 8px; align-items: center; }
        
        .status-badge { padding: 4px 10px; border-radius: 12px; font-weight: bold; font-size: 11px; white-space: nowrap; }
        .status-standby { background: #cbd5e0; color: #2d3748; }
        .status-active { background: #e53e3e; color: white; animation: pulseRed 2s infinite; }
        .status-ended { background: #2f855a; color: white; }
        
        @keyframes pulseRed { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.8; transform: scale(1.05); } 100% { opacity: 1; transform: scale(1); } }
        @keyframes pulseBlue { 0% { background-color: #2b6cb0; } 50% { background-color: #4299e1; } 100% { background-color: #2b6cb0; } }
        
        .role-badge { background: #3182ce; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; white-space: nowrap; }
        .patient-badge { background: #d69e2e; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; display:none; white-space: nowrap; }

        /* --- ãƒ¡ã‚¤ãƒ³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ (ã‚¹ãƒãƒ›æœ€é©åŒ–) --- */
        .main-content { 
            display: flex; 
            flex: 1; 
            overflow: hidden; 
            flex-direction: column; /* ã‚¹ãƒãƒ›ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ç¸¦ä¸¦ã³ */
        }

        /* PC/ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆç”¨ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆå¹…768pxä»¥ä¸Šï¼‰ */
        @media (min-width: 768px) {
            .main-content { flex-direction: row; }
            .left-panel { width: 60%; border-right: 1px solid #e2e8f0; }
            .right-panel { width: 40%; }
        }

        .left-panel, .right-panel {
            padding: 15px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch; /* iOSã§ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ»‘ã‚‰ã‹åŒ– */
        }
        
        .left-panel { background: #fff; flex: 1; }
        .right-panel { background: #f7fafc; flex: 1; border-top: 1px solid #e2e8f0; }

        .section { margin-bottom: 20px; }
        .section-title { 
            font-size: 16px; 
            font-weight: bold; 
            color: #2d3748; 
            margin-bottom: 10px; 
            padding-bottom: 5px; 
            border-bottom: 2px solid #edf2f7; 
            display: flex; align-items: center; gap: 8px; 
        }
        
        /* --- åœ¨åº«ç®¡ç†ãƒ†ãƒ¼ãƒ–ãƒ« --- */
        .stock-table { width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 14px; background: white; }
        .stock-table th { background: #2c5282; color: white; padding: 6px; text-align: center; border: 1px solid #4a5568; font-size: 12px; }
        .stock-table td { padding: 0; text-align: center; border: 1px solid #cbd5e0; }
        .stock-input { width: 100%; padding: 10px 2px; text-align: center; border: none; font-weight: bold; font-size: 18px; color: #2d3748; background: transparent; -webkit-appearance: none; border-radius: 0; }
        .stock-input:focus { background: #fff7ed; outline: 2px solid #ed8936; }
        .stock-input:disabled { background: #f7fafc; color: #4a5568; -webkit-text-fill-color: #4a5568; opacity: 1; }

        /* --- ãƒœã‚¿ãƒ³é¡ (ã‚¿ãƒƒãƒå¯¾å¿œ) --- */
        .doctor-controls { 
            background: white; border: 1px solid #e2e8f0; padding: 10px; border-radius: 8px; margin-bottom: 15px; 
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; /* ã‚¹ãƒãƒ›ã¯2åˆ— */
        }
        @media (min-width: 768px) {
            .doctor-controls { grid-template-columns: repeat(4, 1fr); }
        }

        .doc-btn { 
            padding: 12px 5px; font-weight: bold; border-radius: 6px; cursor: pointer; 
            border: 1px solid #cbd5e0; background: white; color: #718096; transition: all 0.2s; font-size: 12px; 
            min-height: 50px; /* ã‚¿ãƒƒãƒ—é ˜åŸŸç¢ºä¿ */
            display: flex; align-items: center; justify-content: center; text-align: center; line-height: 1.2;
        }
        .doc-btn.active-warn { background: #c05621 !important; color: white !important; border-color: #9c4221 !important; }
        .doc-btn.active-purple { background: #805ad5 !important; color: white !important; border-color: #6b46c1 !important; }
        .doc-btn.active-med { background: #319795 !important; color: white !important; border-color: #285e61 !important; } 
        .doc-btn.active-rapid { background: #d69e2e !important; color: white !important; border-color: #b7791f !important; animation: pulseRed 2s infinite; }

        .mtp-order-group { display: grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 15px; } /* ã‚¹ãƒãƒ›ã¯1åˆ— */
        @media (min-width: 768px) { .mtp-order-group { grid-template-columns: 1fr 1fr; } }

        .mtp-btn { 
            padding: 15px; border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer; border: none; color: white; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: left; display: flex; flex-direction: column; 
            justify-content: center; min-height: 80px; position: relative; 
        }
        .mtp-btn-1 { background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%); }
        .mtp-btn-2 { background: linear-gradient(135deg, #3182ce 0%, #2b6cb0 100%); }
        .mtp-btn small { font-size: 11px; opacity: 0.9; font-weight: normal; margin-top: 4px; }

        /* --- ãƒ©ãƒœãƒ»åœ¨åº«ãƒ‘ãƒãƒ« --- */
        .lab-panel { background: white; padding: 10px; border-radius: 8px; border: 1px solid #cbd5e0; flex-shrink: 0; margin-bottom: 10px; }
        .lab-row { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; }
        .lab-btn { 
            flex: 1; padding: 12px; border: 1px solid #cbd5e0; background: #f7fafc; cursor: pointer; border-radius: 6px; 
            font-weight: bold; color: #4a5568; font-size: 14px; min-height: 44px;
        }
        .lab-btn.selected-abo { background: #3182ce; color: white; border-color: #2b6cb0; }
        .lab-btn.selected-rh { background: #805ad5; color: white; border-color: #6b46c1; }
        .lab-btn.irreg-neg.active { background: #2f855a; color: white; }
        .lab-btn.irreg-pos.active { background: #e53e3e; color: white; }

        .blood-type-big-display { 
            background: #c53030; color: white; padding: 10px; border-radius: 8px; 
            text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 10px;
            flex-shrink: 0; display: none; 
        }
        .blood-type-big-display.active { display: block; animation: fadeIn 0.5s; }
        .blood-type-big-text { font-size: 32px; font-weight: 900; letter-spacing: 1px; line-height: 1; }

        .inventory-summary { background: #edf2f7; padding: 10px; border-radius: 8px; flex-shrink: 0; margin-bottom: 10px; }
        .inventory-grid { display: grid; grid-template-columns: repeat(3, 1fr); text-align: center; color: #2d3748; }
        .inv-val { font-size: 20px; font-weight: bold; }
        
        /* --- ãƒ­ã‚°ãƒ»ãƒãƒ£ãƒƒãƒˆ --- */
        .log-wrapper { flex: 1; display: flex; flex-direction: column; min-height: 200px; margin-bottom: 10px; }
        .tabs { display: flex; gap: 5px; margin-bottom: 0; flex-shrink: 0; }
        .tab-btn { flex: 1; padding: 10px; background: #e2e8f0; border: none; font-weight: bold; color: #718096; border-radius: 6px 6px 0 0; font-size: 13px; }
        .tab-btn.active { background: white; color: #2d3748; border-top: 3px solid #3182ce; }
        
        .log-container { 
            flex: 1; background: white; border-radius: 0 0 6px 6px; padding: 10px; 
            overflow-y: auto; display: flex; flex-direction: column; border: 1px solid #e2e8f0;
            max-height: 300px; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åˆ¶é™ */
        }
        .log-entry { margin-bottom: 6px; font-size: 12px; padding-bottom: 6px; border-bottom: 1px solid #edf2f7; }
        .chat-input-area { margin-top: auto; padding-top: 8px; border-top: 2px solid #e2e8f0; }
        .canned-btn { padding: 6px 10px; background: #edf2f7; border: 1px solid #cbd5e0; border-radius: 15px; font-size: 11px; cursor: pointer; white-space: nowrap; margin-right: 5px; }
        
        .summary-wrapper { flex-shrink: 0; height: 150px; display: flex; flex-direction: column; background:white; border:2px solid #cbd5e0; border-radius:8px; margin-bottom: 20px; } /* ä¸‹éƒ¨ã«ä½™ç™½ */
        .summary-header { background: #4a5568; color:white; padding:6px 10px; font-size:12px; font-weight:bold; display: flex; justify-content: space-between; align-items: center; }
        .summary-content { flex: 1; padding:8px; overflow-y:auto; font-family: monospace; font-size:11px; line-height:1.4; border:none; width:100%; resize:none; outline:none; white-space: pre-wrap; }

        .box-card { background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px; margin-bottom: 10px; border-left: 5px solid #cbd5e0; }
        .box-card.active-box { border-left-color: #3182ce; background: #ebf8ff; border-color: #3182ce; } 
        .box-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-weight: bold; font-size: 14px; color:#4a5568; }
        .item-row { display: grid; grid-template-columns: 110px 60px 1fr; gap: 5px; align-items: center; padding: 6px 0; border-bottom: 1px solid #edf2f7; background: white; font-size: 13px; }
        .status-badge-item { font-size: 10px; padding: 2px 4px; border-radius: 4px; text-align: center; font-weight: bold; white-space: nowrap; }
        .st-pending { background: #edf2f7; color: #718096; }
        .st-preparing { background: #feebc8; color: #c05621; }
        .st-shipped { background: #bee3f8; color: #4299e1; }
        .st-arrived { background: #c6f6d5; color: #2f855a; } 
        .st-infusing { background: #2b6cb0; color: white; animation: pulseBlue 1.5s infinite; }
        .st-completed { background: #2f855a; color: white; }

        .btn { padding: 8px 16px; border: none; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer; color: white; display: inline-flex; align-items: center; justify-content: center; gap: 5px; min-height: 40px; }
        .btn-sm { padding: 4px 8px; font-size: 11px; min-height: 30px; }
        .btn-primary { background: #3182ce; }
        .btn-danger { background: #e53e3e; }
        .btn-success { background: #38a169; }
        .btn-warning { background: #dd6b20; }
        .btn-secondary { background: #718096; }

        .scene-stock-display { position: absolute; top: 60px; right: 10px; background: #2f855a; color: white; padding: 8px 12px; border-radius: 20px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.1); font-size: 12px; z-index: 100; border: 2px solid white; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-card { background: white; padding: 20px; border-radius: 12px; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; text-align: center; }
        .role-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 15px; } /* ã‚¹ãƒãƒ›ã¯2åˆ— */
        @media (min-width: 600px) { .role-grid { grid-template-columns: repeat(4, 1fr); } }

        .role-select-btn { padding: 15px; border: 1px solid #e2e8f0; background: white; border-radius: 8px; font-size: 13px; font-weight: bold; cursor: pointer; color: #4a5568; height: 100%; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:5px; min-height: 80px; }
        .role-icon { font-size: 20px; margin-bottom: 2px; }
        
        .session-list { display: flex; flex-direction: column; gap: 8px; margin-top: 15px; text-align: left; }
        .session-item { padding: 12px; border: 1px solid #cbd5e0; border-radius: 8px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: #f7fafc; }

        .blood-popup { display: none; position: fixed; inset: 0; background: rgba(229, 62, 62, 0.95); z-index: 3000; justify-content: center; align-items: center; flex-direction: column; color: white; animation: fadeIn 0.3s; pointer-events: none; }
        .blood-popup h1 { font-size: 24px; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 2px; border-bottom: 2px solid white; padding-bottom: 5px;}
        .blood-popup div { font-size: 60px; font-weight: 800; text-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .blood-popup.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .hidden { display: none !important; }
        
        #cloudStatus { position: fixed; bottom: 5px; right: 5px; font-size: 10px; color: #cbd5e0; z-index: 50; }
        .cloud-online { color: #48bb78 !important; }
    </style>
</head>
<body>

    <div id="bloodPopup" class="blood-popup">
        <h1>ğŸ©¸ è¡€æ¶²å‹ç¢ºå®š ğŸ©¸</h1>
        <div id="bloodPopupText">A Rh(+)</div>
    </div>

    <div id="loginModal" class="modal active">
        <div class="modal-card">
            <div id="stepRole">
                <h2>å½¹å‰²ã‚’é¸æŠ</h2>
                <div class="role-grid">
                    <button class="role-select-btn" onclick="selectRole('è¼¸è¡€ç®¡ç†éƒ¨')"><span class="role-icon">ğŸ¥</span>è¼¸è¡€éƒ¨<br><span style="font-size:10px;">åœ¨åº«ç®¡ç†</span></button>
                    <button class="role-select-btn" onclick="selectRole('ãƒãƒ¼ãƒ ãƒªãƒ¼ãƒ€ãƒ¼')"><span class="role-icon">ğŸ‘¨â€âš•ï¸</span>ãƒªãƒ¼ãƒ€ãƒ¼</button>
                    <button class="role-select-btn" onclick="selectRole('æ‰‹æŠ€åŒ»å¸«')"><span class="role-icon">ğŸ’‰</span>æ‰‹æŠ€åŒ»å¸«</button>
                    <button class="role-select-btn" onclick="selectRole('è¼¸è¡€ç®¡ç†è²¬ä»»è€…')"><span class="role-icon">ğŸ“‹</span>è²¬ä»»è€…</button>
                    <button class="role-select-btn" onclick="selectRole('è¨˜éŒ²Ns')"><span class="role-icon">ğŸ“</span>è¨˜éŒ²Ns</button>
                    <button class="role-select-btn" onclick="selectRole('ä»‹åŠ©Ns')"><span class="role-icon">ğŸ’Š</span>ä»‹åŠ©Ns</button>
                    <button class="role-select-btn" onclick="selectRole('MTPæ¬é€è€…')"><span class="role-icon">ğŸƒ</span>æ¬é€è€…</button>
                    <button class="role-select-btn" onclick="selectRole('è‡¨åºŠå·¥å­¦æŠ€å¸«')"><span class="role-icon">âš™ï¸</span>ME</button>
                </div>
            </div>
            <div id="stepSession" class="hidden">
                <h2 id="sessionSelectTitle">ç—‡ä¾‹é¸æŠ (Cloud)</h2>
                <div id="bloodDeptDashboard" class="hidden" style="margin-bottom:15px; background:#ebf8ff; padding:10px; border-radius:8px; border:1px solid #bee3f8;">
                    <h3 style="color:#2c5282; margin-bottom:5px; font-size:14px;">ğŸ“¦ é™¢å†…åœ¨åº«ãƒã‚¹ã‚¿ãƒ¼å…¥åŠ›</h3>
                    <p style="font-size:11px; color:#4a5568; margin-bottom:5px;">â€»å…¨ç«¯æœ«ã«å³æ™‚åŒæœŸã•ã‚Œã¾ã™ã€‚</p>
                    <div id="masterStockArea" style="overflow-x: auto;"></div>
                </div>
                <div id="activeSessionsList" class="session-list">
                    <p>èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>
                <div id="newSessionControls" style="margin-top: 15px; padding-top: 15px; border-top: 1px dashed #cbd5e0;">
                    <h3>ã¾ãŸã¯æ–°è¦MTPç™ºå‹•</h3>
                    <div style="display:flex; gap:5px; justify-content:center; margin-top:10px; flex-wrap: wrap;">
                        <input type="text" id="newPid" placeholder="ID" style="padding:10px; font-size:16px; border:1px solid #cbd5e0; border-radius:4px; width:100px;">
                        <input type="text" id="newLoc" placeholder="å ´æ‰€" style="padding:10px; font-size:16px; border:1px solid #cbd5e0; border-radius:4px; width:80px;">
                        <button class="btn btn-danger" onclick="startNewSession()">ğŸš¨ ç™ºå‹•</button>
                    </div>
                </div>
                <div style="margin-top:15px;">
                    <button class="btn btn-secondary btn-sm" onclick="backToRole()">æˆ»ã‚‹</button>
                </div>
            </div>
        </div>
    </div>

    <div id="stockEditModal" class="modal">
        <div class="modal-card">
            <h2>ğŸ“¦ é™¢å†…åœ¨åº«ã®ä¿®æ­£</h2>
            <p style="margin-bottom:10px; font-size:12px;">å…¥åŠ›ã™ã‚‹ã¨è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™ã€‚</p>
            <div id="modalStockArea" style="overflow-x: auto;"></div>
            <button class="btn btn-primary" style="margin-top:20px; width:100%;" onclick="closeStockEdit()">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>MTP Cloud <span style="font-size:10px; font-weight:normal; opacity:0.8;">v28.2</span></h1>
            <div class="header-info">
                <div id="statusBadge" class="status-badge status-standby">å¾…æ©Ÿä¸­</div>
                <div id="patientBadge" class="patient-badge">ID: ---</div>
                <div id="myRoleDisplay" class="role-badge">æœªãƒ­ã‚°ã‚¤ãƒ³</div>
                <button class="btn btn-secondary btn-sm" onclick="location.reload()">é€€å‡º</button>
            </div>
        </div>

        <div class="main-content">
            <div class="left-panel">
                <div id="sceneStock" class="scene-stock-display hidden">
                    ğŸ“ ç¾å ´åœ¨åº«: RBC <span id="sRBC">0</span> / FFP <span id="sFFP">0</span> / PC <span id="sPC">0</span>
                </div>

                <div style="background:#edf2f7; padding:10px; border-radius:8px; margin-bottom:15px; border:1px solid #cbd5e0;">
                    <label style="font-weight:bold; display:flex; justify-content:space-between; align-items:center; color:#2d3748; margin-bottom:5px; font-size:13px;">
                        <span>ğŸ¥ é™¢å†…åœ¨åº« (ãƒã‚¹ã‚¿ãƒ¼åŒæœŸ)</span>
                        <button id="btnEditStock" class="btn btn-primary btn-sm hidden" onclick="openStockEdit()">âœï¸ ä¿®æ­£</button>
                    </label>
                    <div id="viewStockArea" style="overflow-x:auto;"></div>
                </div>

                <div id="activeView" class="hidden">
                    <div id="doctorPanel" class="hidden">
                        <div class="section-title" style="color:#c53030;">ğŸ‘¨â€âš•ï¸ åŒ»å¸«æŒ‡ç¤ºãƒ»ã‚ªãƒ¼ãƒ€ãƒ¼</div>
                        <div class="mtp-order-group">
                            <button class="mtp-btn mtp-btn-1" onclick="orderMTP(1)"><span>â‘  MTPã‚ªãƒ¼ãƒ€ãƒ¼ 1</span><small>BOX1 (Oå‹RBC + ABå‹FFP)</small></button>
                            <button class="mtp-btn mtp-btn-2" onclick="orderMTP(2)"><span>â‘¡ MTPã‚ªãƒ¼ãƒ€ãƒ¼ 2</span><small>BOX2(åŒå‹) + BOX3(PCå«)</small></button>
                        </div>
                        <div class="doctor-controls">
                            <button class="doc-btn" id="btnWarn" onclick="toggleDocBtn('warn', 'ç•°å‹è¼¸è¡€ã‚’å®£è¨€')">âš ï¸ ç•°å‹è¼¸è¡€<br>å®£è¨€</button>
                            <button class="doc-btn" id="btnBlood" onclick="toggleDocBtn('blood', 'è¡€æ¶²å‹æ¡è¡€2å›æ¸ˆã¿')">ğŸ’‰ æ¡è¡€<br>2å›æ¸ˆ</button>
                            <button class="doc-btn" id="btnEnd" onclick="endMTP()">ğŸ MTP<br>çµ‚äº†å®£è¨€</button>
                            <button class="doc-btn" id="btnMove" onclick="moveToWard()">ğŸ¥ ç—…æ£Ÿå…¥å®¤<br>(å®Œçµ)</button>
                        </div>
                        <div style="border-top:1px dashed #cbd5e0; padding-top:10px; margin-top:10px;">
                            <div style="font-size:13px; font-weight:bold; color:#2c5282; margin-bottom:5px;">ğŸ’Š è–¬å‰¤æŠ•ä¸æŒ‡ç¤º</div>
                            <div class="doctor-controls" style="grid-template-columns: repeat(3, 1fr);">
                                <button class="doc-btn" id="btnFib" onclick="toggleMed('fib', 'ãƒ•ã‚£ãƒ–ãƒªãƒã‚²ãƒ³')">ãƒ•ã‚£ãƒ–ãƒªãƒã‚²ãƒ³</button>
                                <button class="doc-btn" id="btnTrans" onclick="toggleMed('trans', 'ãƒˆãƒ©ãƒ³ã‚µãƒŸãƒ³')">ãƒˆãƒ©ãƒ³ã‚µãƒŸãƒ³</button>
                                <button class="doc-btn" id="btnK2" onclick="toggleMed('k2', 'ã‚±ã‚¤ãƒ„ãƒ¼')">ã‚±ã‚¤ãƒ„ãƒ¼</button>
                                <button class="doc-btn" id="btnPrax" onclick="toggleMed('prax', 'ãƒ—ãƒªã‚ºãƒã‚¤ãƒ³ãƒ‰')">ãƒ—ãƒªã‚ºãƒã‚¤ãƒ³ãƒ‰</button>
                                <button class="doc-btn" id="btnKcentra" onclick="toggleMed('kcentra', 'ã‚±ã‚¤ã‚»ãƒ³ãƒˆãƒ©')">ã‚±ã‚¤ã‚»ãƒ³ãƒˆãƒ©</button>
                            </div>
                        </div>
                    </div>

                    <div id="cePanel" class="hidden" style="margin-bottom:20px; border:2px solid #b7791f; border-radius:8px; padding:10px; background:white;">
                        <div class="section-title" style="color:#b7791f;">âš™ï¸ è‡¨åºŠå·¥å­¦æŠ€å¸«ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</div>
                        <button class="doc-btn" id="btnRapid" style="width:100%; font-size:16px; padding:15px; background:#feebc8; color:#744210;" onclick="toggleRapid()">âš¡ ãƒ©ãƒ”ãƒƒãƒ‰ã‚¤ãƒ³ãƒ’ãƒ¥ãƒ¼ã‚¶ãƒ¼é–‹å§‹</button>
                    </div>

                    <div class="section">
                        <div class="section-title">ğŸ“¦ è¼¸è¡€ã‚ªãƒ¼ãƒ€ãƒ¼çŠ¶æ³</div>
                        <div id="boxesContainer"></div>
                    </div>
                </div>
            </div>

            <div class="right-panel">
                <div id="bloodBigDisplay" class="blood-type-big-display">
                    <span class="blood-type-big-label">BLOOD TYPE CONFIRMED</span>
                    <span id="bloodBigText" class="blood-type-big-text"></span>
                </div>

                <div class="lab-panel">
                    <div class="section-title" style="font-size:14px; margin-bottom:10px;">ğŸ©¸ è¡€æ¶²å‹ç¢ºå®š (è¼¸è¡€éƒ¨ã®ã¿)</div>
                    <div class="lab-row">
                        <button class="lab-btn" id="btnA" onclick="setBloodType('A')">A</button>
                        <button class="lab-btn" id="btnB" onclick="setBloodType('B')">B</button>
                        <button class="lab-btn" id="btnO" onclick="setBloodType('O')">O</button>
                        <button class="lab-btn" id="btnAB" onclick="setBloodType('AB')">AB</button>
                    </div>
                    <div class="lab-row">
                        <button class="lab-btn" id="btnRhP" onclick="setRh('+')">Rh(+)</button>
                        <button class="lab-btn" id="btnRhM" onclick="setRh('-')">Rh(-)</button>
                    </div>
                    <div class="lab-row">
                        <button class="lab-btn irreg-neg" id="btnIrregNeg" onclick="setIrreg('neg')">ä¸è¦å‰‡æŠ—ä½“ï¼šãªã—</button>
                        <button class="lab-btn irreg-pos" id="btnIrregPos" onclick="setIrreg('pos')">ä¸è¦å‰‡æŠ—ä½“ï¼šã‚ã‚Š</button>
                    </div>
                </div>

                <div class="inventory-summary">
                    <h3 style="margin-bottom:5px; border-bottom:1px solid rgba(255,255,255,0.2); font-size:13px;">ğŸ“Š ã“ã®ç—‡ä¾‹ã®æŠ•ä¸æ¸ˆã¿ç´¯è¨ˆ</h3>
                    <div class="inventory-grid">
                        <div><div class="inv-val" id="sumRBC">0</div><div>RBC</div></div>
                        <div><div class="inv-val" id="sumFFP">0</div><div>FFP</div></div>
                        <div><div class="inv-val" id="sumPC">0</div><div>PC</div></div>
                    </div>
                </div>

                <div class="log-wrapper">
                    <div class="tabs">
                        <button class="tab-btn active" onclick="showTab('chat')">ğŸ’¬ ãƒãƒ£ãƒƒãƒˆ</button>
                        <button class="tab-btn" onclick="showTab('log')">ğŸ“‹ ãƒ­ã‚°</button>
                    </div>
                    <div id="tabChat" class="log-container">
                        <div id="chatArea" style="flex:1; overflow-y:auto; margin-bottom:5px;"></div>
                        <div class="chat-input-area">
                            <div id="cannedButtons" style="display:flex; gap:5px; margin-bottom:5px; overflow-x:auto; padding-bottom:5px;"></div>
                            <div style="display:flex; gap:5px;">
                                <input type="text" id="chatInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸..." style="flex:1; padding:8px; border:1px solid #ccc; border-radius:4px; font-size:16px;">
                                <button class="btn btn-primary btn-sm" onclick="sendChat()">é€ä¿¡</button>
                            </div>
                        </div>
                    </div>
                    <div id="tabLog" class="log-container hidden"></div>
                </div>

                <div class="summary-wrapper">
                    <div class="summary-header">
                        <span>ğŸ“ MTPè¨˜éŒ²ã‚µãƒãƒªãƒ¼</span>
                        <button class="btn btn-primary btn-sm" onclick="copySummary()" style="padding:2px 8px; font-size:11px;">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
                    </div>
                    <textarea id="realtimeSummary" class="summary-content" readonly></textarea>
                </div>
            </div>
        </div>
    </div>
    <div id="cloudStatus">â— Cloud</div>

    <script>
        // =================================================================
        // Firebaseè¨­å®š (ãƒ¦ãƒ¼ã‚¶ãƒ¼æ§˜ã®ã‚­ãƒ¼ã‚’é©ç”¨æ¸ˆã¿)
        // =================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyDdqljAVfjGzKWAA1oWsbnwIphifYMnr-E",
            authDomain: "mtp-project-c8f20.firebaseapp.com",
            projectId: "mtp-project-c8f20",
            storageBucket: "mtp-project-c8f20.firebasestorage.app",
            messagingSenderId: "48202967020",
            appId: "1:48202967020:web:626950d14dfb088200c2c9",
            measurementId: "G-QPM4YE65VH"
        };
        // =================================================================

        // FirebaseåˆæœŸåŒ–
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // ã‚¢ãƒ—ãƒªã®çŠ¶æ…‹
        let myRole = "";
        let currentSessionId = null; 
        let currentSessionData = null; // ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ¼ã‚¿ä¿æŒç”¨
        let lastBloodState = ""; 
        let unsubscribeSession = null;
        let unsubscribeInventory = null;
        
        // é™¢å†…åœ¨åº«(Inventory)ã¯åˆ¥ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ "master/inventory" ã§ç®¡ç†
        let hospitalStock = {RBC:{A:0,B:0,O:0,AB:0},FFP:{A:0,B:0,O:0,AB:0},PC:{A:0,B:0,O:0,AB:0}};

        const ROLES = {
            DOCTOR: ['ãƒãƒ¼ãƒ ãƒªãƒ¼ãƒ€ãƒ¼', 'æ‰‹æŠ€åŒ»å¸«', 'è¼¸è¡€ç®¡ç†è²¬ä»»è€…'],
            NURSE: ['è¨˜éŒ²Ns', 'ä»‹åŠ©Ns'],
            BLOOD: ['è¼¸è¡€ç®¡ç†éƒ¨'],
            TRANS: ['MTPæ¬é€è€…', 'è‡¨åºŠå·¥å­¦æŠ€å¸«']
        };

        const CANNED_MESSAGES = {
            DOCTOR: ['é–‹è…¹è¡“é–‹å§‹', 'é–‹èƒ¸è¡“é–‹å§‹', 'é–‹é ­è¡“é–‹å§‹', 'IVRé–‹å§‹', 'ãƒã‚¤ã‚¿ãƒ«ä¸å®‰å®š', 'ãƒ–ãƒ©ãƒƒãƒ‰ã‚¢ã‚¯ã‚»ã‚¹æŒ¿å…¥', 'æ°—ç®¡æŒ¿ç®¡å®Ÿæ–½', 'REBOAæŒ¿å…¥'],
            BLOOD: ['ç•°å‹ã§å‡ºã—ã¾ã™', 'åŒå‹æœªã‚¯ãƒ­ã‚¹ã§ã™', 'ä»¥å¾Œã‚¯ãƒ­ã‚¹ãƒãƒƒãƒæ¸ˆã¿ã§ã™', 'åœ¨åº«ç¢ºèªä¸­'],
            NURSE: ['ç•°å‹è¼¸è¡€å®£è¨€ç¢ºèª', 'è¡€å‹2å›æå‡ºæ¸ˆ', 'CTå‡ºç™º', 'ã‚¢ãƒ³ã‚®ã‚ªå‡ºç™º', 'ç·Šæ€¥æ‰‹è¡“é–‹å§‹', 'åˆ°ç€ã—ã¾ã—ãŸ', 'æŠ•ä¸é–‹å§‹ã—ã¾ã™'],
            TRANS: ['åˆ°ç€ã—ã¾ã—ãŸ', 'æŠ•ä¸é–‹å§‹ã—ã¾ã™', 'æ¬¡ã®ã‚ªãƒ¼ãƒ€ãƒ¼ãŠé¡˜ã„ã—ã¾ã™', 'äº†è§£ã—ã¾ã—ãŸ']
        };

        function getCannedMessages() {
            if(ROLES.DOCTOR.includes(myRole)) return CANNED_MESSAGES.DOCTOR;
            if(ROLES.BLOOD.includes(myRole)) return CANNED_MESSAGES.BLOOD;
            if(ROLES.NURSE.includes(myRole)) return CANNED_MESSAGES.NURSE;
            if(ROLES.TRANS.includes(myRole)) return CANNED_MESSAGES.TRANS;
            return ['äº†è§£ã—ã¾ã—ãŸ'];
        }

        function renderCannedButtons() {
            const container = document.getElementById('cannedButtons');
            const messages = getCannedMessages();
            container.innerHTML = messages.map(msg => 
                `<button class="canned-btn" onclick="postChat('${msg}')">${msg}</button>`
            ).join('');
        }

        // --- Firestore æ¥ç¶šçŠ¶æ³ ---
        const cloudStatus = document.getElementById('cloudStatus');
        if(cloudStatus) cloudStatus.classList.add('cloud-online');

        // --- ãƒ­ãƒ¼ãƒ«é¸æŠ ---
        function selectRole(role) {
            myRole = role;
            document.getElementById("myRoleDisplay").textContent = role;
            document.getElementById("stepRole").classList.add("hidden");
            document.getElementById("stepSession").classList.remove("hidden");

            // åœ¨åº«ãƒã‚¹ã‚¿ãƒ¼ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸã‚’é–‹å§‹
            startInventorySync();

            // åœ¨åº«ãƒ†ãƒ¼ãƒ–ãƒ«åˆæœŸæç”»
            if(!document.getElementById("master_RBC_A")) {
                document.getElementById("masterStockArea").innerHTML = generateStockTableHTML("master", true);
                document.getElementById("viewStockArea").innerHTML = generateStockTableHTML("view", false); 
                document.getElementById("modalStockArea").innerHTML = generateStockTableHTML("modal", true);
            }

            // ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§ã®èª­ã¿è¾¼ã¿é–‹å§‹
            loadActiveSessions();

            if(role === 'è¼¸è¡€ç®¡ç†éƒ¨') {
                document.getElementById("bloodDeptDashboard").classList.remove("hidden");
                document.getElementById("sessionSelectTitle").textContent = "åœ¨åº«ç®¡ç†ã¾ãŸã¯ç—‡ä¾‹å‚åŠ ";
            }
        }

        function backToRole() {
            document.getElementById("stepSession").classList.add("hidden");
            document.getElementById("bloodDeptDashboard").classList.add("hidden");
            document.getElementById("stepRole").classList.remove("hidden");
            if(unsubscribeInventory) unsubscribeInventory();
        }

        // --- Inventory Sync (é™¢å†…åœ¨åº«) ---
        function startInventorySync() {
            unsubscribeInventory = db.collection("master").doc("inventory").onSnapshot((doc) => {
                if(doc.exists) {
                    hospitalStock = doc.data();
                } else {
                    // åˆæœŸåŒ–
                    db.collection("master").doc("inventory").set(hospitalStock);
                }
                renderStock();
            });
        }

        function renderStock() {
            ['master','view','modal'].forEach(prefix => {
                if(document.getElementById(`${prefix}_RBC_A`)) {
                    ['RBC','FFP','PC'].forEach(prod => {
                        ['A','B','O','AB'].forEach(type => {
                            const el = document.getElementById(`${prefix}_${prod}_${type}`);
                            const val = (hospitalStock[prod] && hospitalStock[prod][type] !== undefined) ? hospitalStock[prod][type] : 0;
                            if(el && document.activeElement !== el) el.value = val;
                        });
                    });
                }
            });
        }

        // åœ¨åº«å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
        function onStockInput(el) {
            const parts = el.id.split('_'); 
            const prod = parts[1];
            const type = parts[2];
            const val = parseInt(el.value);
            
            // ãƒ­ãƒ¼ã‚«ãƒ«åæ˜ 
            if(!hospitalStock[prod]) hospitalStock[prod] = {};
            hospitalStock[prod][type] = isNaN(val) ? 0 : val;
        }

        function onStockChange(el) {
            // Firestoreã¸ä¿å­˜
            db.collection("master").doc("inventory").set(hospitalStock)
                .then(() => console.log("Inventory Saved"));
        }

        function onStockFocus() { /* ç·¨é›†ä¸­ã®ãƒ•ãƒ©ã‚°åˆ¶å¾¡ã¯FirestoreåŒæœŸã§ã¯ä¸è¦ã ãŒUIæŒ™å‹•ã®ãŸã‚æ®‹ã™ */ }
        function onStockKeyDown(e, el) {
            if(e.key === 'Enter') {
                e.preventDefault();
                el.blur(); 
                const parts = el.id.split('_'); 
                const prefix = parts[0];
                const prod = parts[1];
                const type = parts[2];
                const products = ['RBC', 'FFP', 'PC'];
                const types = ['A', 'B', 'O', 'AB'];
                let pIdx = products.indexOf(prod);
                let tIdx = types.indexOf(type);
                tIdx++;
                if(tIdx >= types.length) { tIdx = 0; pIdx++; }
                if(pIdx < products.length) {
                    const nextId = `${prefix}_${products[pIdx]}_${types[tIdx]}`;
                    const nextEl = document.getElementById(nextId);
                    if(nextEl) { nextEl.focus(); nextEl.select(); }
                }
            }
        }

        // --- Sessions Management ---
        function loadActiveSessions() {
            const sessionListEl = document.getElementById("activeSessionsList");
            db.collection("mtp_sessions")
              .where("status", "!=", "completed")
              .onSnapshot((snapshot) => {
                  if(snapshot.empty) {
                      sessionListEl.innerHTML = "<p style='color:#718096; text-align:center;'>é€²è¡Œä¸­ã®MTPã¯ã‚ã‚Šã¾ã›ã‚“</p>";
                      return;
                  }
                  sessionListEl.innerHTML = snapshot.docs.map(doc => {
                      const s = doc.data();
                      const statusText = s.status === 'ended' ? ' [çµ‚äº†]' : '';
                      const statusColor = s.status === 'ended' ? '#2f855a' : '#3182ce';
                      return `
                        <div class="session-item" onclick="joinSession('${s.id}')">
                            <div><div style="font-weight:bold; font-size:16px;">ğŸ†” ${s.id}${statusText}</div><div style="font-size:12px; color:#718096;">ğŸ“ ${s.location} / é–‹å§‹: ${s.start_time}</div></div>
                            <button class="btn btn-sm" style="background:${statusColor};">å‚åŠ </button>
                        </div>
                    `;
                  }).join("");
              });
        }

        function startNewSession() {
            const pid = document.getElementById("newPid").value.trim();
            const loc = document.getElementById("newLoc").value.trim();
            if(!pid) return alert("IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

            const docRef = db.collection("mtp_sessions").doc(pid);
            docRef.get().then(doc => {
                if(doc.exists && (doc.data().status === 'active' || doc.data().status === 'ended')) {
                    alert("æ—¢ã«åŒã˜IDã®MTPãŒå­˜åœ¨ã—ã¾ã™");
                    return;
                }
                const newS = {
                    id: pid, location: loc, status: "active",
                    start_time: new Date().toLocaleTimeString('ja-JP', {hour:'2-digit', minute:'2-digit'}),
                    boxes: [], 
                    logs: [{t:getTime(), r:myRole, m:`ğŸš¨ MTPç™ºå‹• æ‚£è€…ID:${pid} å ´æ‰€:${loc}`}], 
                    chats: [], 
                    used: {RBC:0,FFP:0,PC:0},
                    blood_res: {abo:"",rh:"",irreg_type:""}, 
                    doc_flags:{warn:false,blood:false},
                    medications: {fib:false, trans:false, k2:false, prax:false, kcentra:false},
                    rapid_infuser: false
                };
                docRef.set(newS).then(() => joinSession(pid));
            });
        }

        function joinSession(pid) {
            currentSessionId = pid;
            document.getElementById("loginModal").classList.remove("active");
            
            // ãƒ­ã‚°è¿½åŠ 
            addLog("ãƒ­ã‚°ã‚¤ãƒ³");

            // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸé–‹å§‹
            unsubscribeSession = db.collection("mtp_sessions").doc(pid).onSnapshot(doc => {
                if(!doc.exists) { alert("ç—‡ä¾‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"); location.reload(); return; }
                currentSessionData = doc.data();
                renderSession(currentSessionData);
            });
        }

        // --- Rendering Logic (å‰å›æ¶ˆå¤±ã—ã¦ã„ãŸéƒ¨åˆ†ã‚’å¾©å…ƒ) ---
        function renderSession(session) {
            if(!session) return;

            // 1. è¡€æ¶²å‹è¡¨ç¤º
            const confirmed = (session.blood_res.abo && session.blood_res.rh);
            const currentBloodState = `${session.blood_res.abo}_${session.blood_res.rh}`;
            if (confirmed) {
                const bigDisp = document.getElementById('bloodBigDisplay');
                document.getElementById('bloodBigText').textContent = `${session.blood_res.abo}å‹ Rh(${session.blood_res.rh})`;
                bigDisp.classList.add('active');
                if (currentBloodState !== lastBloodState) {
                    if(lastBloodState !== "") showBloodPopup(session.blood_res.abo, session.blood_res.rh);
                    lastBloodState = currentBloodState;
                }
            } else {
                document.getElementById('bloodBigDisplay').classList.remove('active');
            }
            if(lastBloodState === "") lastBloodState = currentBloodState;

            // 2. ãƒ‘ãƒãƒ«è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
            document.getElementById("activeView").classList.remove("hidden");
            document.getElementById("patientBadge").style.display = "block";
            document.getElementById("patientBadge").textContent = `ID: ${session.id}`;

            const badge = document.getElementById("statusBadge");
            if(session.status === 'active') {
                badge.textContent = "MTPç™ºå‹•ä¸­";
                badge.className = "status-badge status-active";
                document.getElementById("sceneStock").classList.remove("hidden");
            } else if(session.status === 'ended') {
                badge.textContent = "MTPçµ‚äº†";
                badge.className = "status-badge status-ended";
                document.getElementById("sceneStock").classList.remove("hidden");
            }

            const isDoc = ROLES.DOCTOR.includes(myRole);
            const isBlood = ROLES.BLOOD.includes(myRole);
            const isCE = (myRole === 'è‡¨åºŠå·¥å­¦æŠ€å¸«');

            document.getElementById("doctorPanel").className = (isDoc && session.status === 'active') ? "" : "hidden";
            if(isBlood) document.getElementById("btnEditStock").classList.remove("hidden");
            if(isCE && session.status === 'active') document.getElementById("cePanel").classList.remove("hidden");
            else document.getElementById("cePanel").classList.add("hidden");

            // 3. ãƒ•ãƒ©ã‚°ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹
            const flags = session.doc_flags || {warn:false, blood:false};
            const med = session.medications || {fib:false, trans:false, k2:false, prax:false, kcentra:false};
            if(document.getElementById("btnWarn")) document.getElementById("btnWarn").className = flags.warn ? "doc-btn active-warn" : "doc-btn";
            if(document.getElementById("btnBlood")) document.getElementById("btnBlood").className = flags.blood ? "doc-btn active-purple" : "doc-btn";
            ['fib','trans','k2','prax','kcentra'].forEach(k => {
                const btn = document.getElementById('btn'+k.charAt(0).toUpperCase() + k.slice(1));
                if(btn) btn.className = med[k] ? "doc-btn active-med" : "doc-btn";
            });
            const btnRapid = document.getElementById("btnRapid");
            if(btnRapid) {
                btnRapid.className = session.rapid_infuser ? "doc-btn active-rapid" : "doc-btn";
                btnRapid.textContent = session.rapid_infuser ? "âš¡ ãƒ©ãƒ”ãƒƒãƒ‰ã‚¤ãƒ³ãƒ’ãƒ¥ãƒ¼ã‚¶ãƒ¼ä½¿ç”¨ä¸­" : "âš¡ ãƒ©ãƒ”ãƒƒãƒ‰ã‚¤ãƒ³ãƒ’ãƒ¥ãƒ¼ã‚¶ãƒ¼é–‹å§‹";
            }

            // 4. ã‚µãƒ–ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å®Ÿè¡Œ
            calcSceneStock(session);
            renderBoxes(session);
            renderLab(session, isBlood);
            renderLogs(session);
            renderCannedButtons();
            updateSummary(session);
        }

        function calcSceneStock(session) {
            let sRBC=0, sFFP=0, sPC=0;
            session.boxes.forEach(box => {
                box.items.forEach(i => {
                    if(i.status === 'arrived') {
                        if(i.type.includes('RBC')) sRBC += i.units;
                        else if(i.type.includes('FFP')) sFFP += i.units;
                        else if(i.type.includes('PC')) sPC += i.units;
                    }
                });
            });
            document.getElementById("sRBC").textContent = sRBC;
            document.getElementById("sFFP").textContent = sFFP;
            document.getElementById("sPC").textContent = sPC;
            document.getElementById("sumRBC").textContent = session.used ? session.used.RBC : 0;
            document.getElementById("sumFFP").textContent = session.used ? session.used.FFP : 0;
            document.getElementById("sumPC").textContent = session.used ? session.used.PC : 0;
        }

        // --- Actions (Firestoreã¸ã®æ›¸ãè¾¼ã¿) ---

        function orderMTP(type) {
            if(!currentSessionId) return;
            const s = currentSessionData;
            
            if(type===2 && (!s.blood_res.abo || !s.blood_res.rh)) {
                alert("è¡€æ¶²å‹ãŒç¢ºå®šã—ã¦ã„ã¾ã›ã‚“");
                return;
            }
            
            const tid = Date.now();
            let newBoxes = [];
            let bName = "";
            let logMsg = "";
            let chatMsg = "";
            
            if(type===1) {
                bName = "BOX1 (ç•°å‹)";
                const items = [
                    {type:'O_RBC',units:2, realType:'O'}, {type:'O_RBC',units:2, realType:'O'}, {type:'O_RBC',units:2, realType:'O'},
                    {type:'AB_FFP',units:2, realType:'AB'}, {type:'AB_FFP',units:2, realType:'AB'}, {type:'AB_FFP',units:2, realType:'AB'}
                ];
                newBoxes.push({name:bName, items: items.map((i,idx)=>({...i, id:`${tid}-1-${idx}`, status:'pending'}))});
                logMsg = "ğŸ“¦ MTPã‚ªãƒ¼ãƒ€ãƒ¼â‘  BOX1(ç•°å‹) ç™ºæ³¨";
                chatMsg = "ğŸ“¦ ã‚ªãƒ¼ãƒ€ãƒ¼â‘  (BOX1) æŒ‡ç¤º";
            } else {
                const abo = s.blood_res.abo; 
                let items = [
                    {type:'RBC',units:2, realType:abo}, {type:'RBC',units:2, realType:abo},
                    {type:'FFP',units:2, realType:abo}, {type:'FFP',units:2, realType:abo}
                ];
                newBoxes.push({name:"BOX2 (åŒå‹)", items: items.map((i,idx)=>({...i, id:`${tid}-2-${idx}`, status:'pending'}))});
                
                items = [
                    {type:'RBC',units:2, realType:abo}, {type:'FFP',units:2, realType:abo},
                    {type:'PC',units:10, realType:abo}, {type:'PC',units:10, realType:abo}
                ];
                newBoxes.push({name:"BOX3 (PCå«)", items: items.map((i,idx)=>({...i, id:`${tid}-3-${idx}`, status:'pending'}))});
                
                logMsg = `ğŸ“¦ MTPã‚ªãƒ¼ãƒ€ãƒ¼â‘¡ BOX2+3(åŒå‹ ${abo}å‹) ç™ºæ³¨`;
                chatMsg = "ğŸ“¦ ã‚ªãƒ¼ãƒ€ãƒ¼â‘¡ (BOX2+3) æŒ‡ç¤º";
            }

            const docRef = db.collection("mtp_sessions").doc(currentSessionId);
            docRef.update({
                boxes: firebase.firestore.FieldValue.arrayUnion(...newBoxes),
                logs: firebase.firestore.FieldValue.arrayUnion({t:getTime(), r:myRole, m:logMsg}),
                chats: firebase.firestore.FieldValue.arrayUnion({t:getTime(), r:myRole, m:chatMsg})
            });
        }

        // ã‚¢ã‚¤ãƒ†ãƒ æ“ä½œï¼ˆé…åˆ—ã®ä¸­èº«ã‚’æ›´æ–°ã™ã‚‹ãŸã‚ã€ä¸€åº¦èª­ã‚“ã§æ›¸ãæ›ãˆã‚‹ï¼‰
        function itemAction(bIdx, iId, st) {
            const docRef = db.collection("mtp_sessions").doc(currentSessionId);
            db.runTransaction(async (transaction) => {
                const sfDoc = await transaction.get(docRef);
                if (!sfDoc.exists) throw "Document does not exist!";
                
                const s = sfDoc.data();
                const boxes = s.boxes;
                const item = boxes[bIdx].items.find(i=>i.id===iId);
                
                if(!item) return;

                // åœ¨åº«æ¸›ç®—å‡¦ç† (é™¢å†…åœ¨åº«ãƒã‚¹ã‚¿ãƒ¼ã‹ã‚‰å¼•ã)
                if(st === 'shipped' && item.status !== 'shipped') {
                    let p = item.type; 
                    let t = item.realType || item.type;
                    if(item.type === 'O_RBC') { p='RBC'; t='O'; }
                    if(item.type === 'AB_FFP') { p='FFP'; t='AB'; }
                    deductMasterStock(p, t, item.units);
                }

                item.status = st;
                
                let statusText = "";
                if(st==='preparing') statusText = "æº–å‚™é–‹å§‹";
                if(st==='shipped') statusText = "å‡ºåº«å®Œäº†";
                if(st==='arrived') statusText = "ç¾å ´åˆ°ç€";
                if(st==='infusing') statusText = "æŠ•ä¸é–‹å§‹";
                
                let usedUpdate = {};
                if(st==='completed') {
                    statusText = "æŠ•ä¸å®Œäº†";
                    if(item.type.includes('RBC')) usedUpdate = {"used.RBC": firebase.firestore.FieldValue.increment(item.units)};
                    else if(item.type.includes('FFP')) usedUpdate = {"used.FFP": firebase.firestore.FieldValue.increment(item.units)};
                    else usedUpdate = {"used.PC": firebase.firestore.FieldValue.increment(item.units)};
                }

                const logEntry = {t:getTime(), r:myRole, m:`${item.type} ${item.units}U - ${statusText}`};
                
                transaction.update(docRef, { 
                    boxes: boxes, 
                    logs: firebase.firestore.FieldValue.arrayUnion(logEntry),
                    ...usedUpdate
                });
            });
        }
        
        // é™¢å†…åœ¨åº«æ¸›ç®—ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼
        function deductMasterStock(prod, type, units) {
            let targetProd = prod.includes('RBC') ? 'RBC' : prod.includes('FFP') ? 'FFP' : 'PC';
            let targetType = type.split('_')[0];
            
            const invRef = db.collection("master").doc("inventory");
            // Firestoreã®ãƒã‚¹ãƒˆã•ã‚ŒãŸãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ›´æ–°
            const fieldPath = `${targetProd}.${targetType}`;
            invRef.update({
                [fieldPath]: firebase.firestore.FieldValue.increment(-units)
            }).catch(err => console.log("Inventory update err (create new if needed)", err));
        }

        // ãƒœãƒƒã‚¯ã‚¹ä¸€æ‹¬æ“ä½œ
        function batchBox(bIdx, st) {
            if(st !== 'arrived' && !confirm("ä¸€æ‹¬æ“ä½œã—ã¾ã™ã‹ï¼Ÿ")) return;
            const docRef = db.collection("mtp_sessions").doc(currentSessionId);

            db.runTransaction(async (transaction) => {
                const sfDoc = await transaction.get(docRef);
                const s = sfDoc.data();
                const boxes = s.boxes;
                let count = 0;

                boxes[bIdx].items.forEach(i=>{
                    let changed = false;
                    if(st==='preparing' && i.status==='pending') changed = true;
                    if(st==='shipped' && i.status==='preparing') {
                        let p = i.type; 
                        let t = i.realType || i.type;
                        if(i.type === 'O_RBC') { p='RBC'; t='O'; }
                        if(i.type === 'AB_FFP') { p='FFP'; t='AB'; }
                        deductMasterStock(p, t, i.units);
                        changed = true;
                    }
                    if(st==='arrived' && i.status==='shipped') changed = true;
                    
                    if(changed) {
                        i.status = st;
                        count++;
                    }
                });
                
                if(count > 0) {
                    let actionName = (st==='preparing')?"ä¸€æ‹¬æº–å‚™":(st==='shipped')?"ä¸€æ‹¬å‡ºåº«":"ä¸€æ‹¬åˆ°ç€";
                    const logEntry = {t:getTime(), r:myRole, m:`${boxes[bIdx].name} ${actionName} (${count}ä»¶)`};
                    transaction.update(docRef, { boxes: boxes, logs: firebase.firestore.FieldValue.arrayUnion(logEntry) });
                }
            });
        }

        // ãƒ•ãƒ©ã‚°åˆ‡ã‚Šæ›¿ãˆç³»
        function toggleDocBtn(k,m) {
            const docRef = db.collection("mtp_sessions").doc(currentSessionId);
            const currentVal = currentSessionData.doc_flags ? currentSessionData.doc_flags[k] : false;
            const newVal = !currentVal;
            const action = newVal ? "ON" : "OFF";
            
            docRef.update({
                [`doc_flags.${k}`]: newVal,
                logs: firebase.firestore.FieldValue.arrayUnion({t:getTime(), r:myRole, m:`ğŸš¨ ${m} ${action}`}),
                chats: firebase.firestore.FieldValue.arrayUnion({t:getTime(), r:myRole, m:`ğŸš¨ ${m} (${action})`})
            });
        }
        
        function toggleMed(k, label) {
            const docRef = db.collection("mtp_sessions").doc(currentSessionId);
            const currentVal = currentSessionData.medications ? currentSessionData.medications[k] : false;
            const newVal = !currentVal;
            const action = newVal ? "æŠ•ä¸æŒ‡ç¤º" : "æŒ‡ç¤ºå–æ¶ˆ";

            docRef.update({
                [`medications.${k}`]: newVal,
                logs: firebase.firestore.FieldValue.arrayUnion({t:getTime(), r:myRole, m:`ğŸ’Š ${label} ${action}`}),
                chats: firebase.firestore.FieldValue.arrayUnion({t:getTime(), r:myRole, m:`ğŸ’Š ${label} ${action}`})
            });
        }
        
        function toggleRapid() {
            const docRef = db.collection("mtp_sessions").doc(currentSessionId);
            const currentVal = currentSessionData.rapid_infuser || false;
            const newVal = !currentVal;
            const msg = newVal ? "ãƒ©ãƒ”ãƒƒãƒ‰ã‚¤ãƒ³ãƒ’ãƒ¥ãƒ¼ã‚¶ãƒ¼ä½¿ç”¨é–‹å§‹" : "ãƒ©ãƒ”ãƒƒãƒ‰ã‚¤ãƒ³ãƒ’ãƒ¥ãƒ¼ã‚¶ãƒ¼åœæ­¢";

            docRef.update({
                rapid_infuser: newVal,
                logs: firebase.firestore.FieldValue.arrayUnion({t:getTime(), r:myRole, m:`âš¡ ${msg}`}),
                chats: firebase.firestore.FieldValue.arrayUnion({t:getTime(), r:myRole, m:`âš¡ ${msg}`})
            });
        }

        // è¡€æ¶²å‹
        function setBloodType(t) {
            if(!ROLES.BLOOD.includes(myRole)) return;
            const s = currentSessionData;
            if(s.blood_res.abo !== t) {
                db.collection("mtp_sessions").doc(currentSessionId).update({
                    "blood_res.abo": t,
                    logs: firebase.firestore.FieldValue.arrayUnion({t:getTime(), r:myRole, m:`ğŸ©¸ è¡€æ¶²å‹åˆ¤å®š: ${t}å‹`}),
                    chats: firebase.firestore.FieldValue.arrayUnion({t:getTime(), r:myRole, m:`ğŸ©¸ è¡€æ¶²å‹: ${t}å‹ ç¢ºå®š`})
                });
            }
        }
        
        function setRh(t) {
            if(!ROLES.BLOOD.includes(myRole)) return;
            const s = currentSessionData;
            const v = t==='+'?'+':'-';
            if(s.blood_res.rh !== v) {
                db.collection("mtp_sessions").doc(currentSessionId).update({
                    "blood_res.rh": v,
                    logs: firebase.firestore.FieldValue.arrayUnion({t:getTime(), r:myRole, m:`ğŸ©¸ Rhåˆ¤å®š: Rh(${v})`}),
                    chats: firebase.firestore.FieldValue.arrayUnion({t:getTime(), r:myRole, m:`ğŸ©¸ Rh: Rh(${v}) ç¢ºå®š`})
                });
            }
        }
        
        function setIrreg(val) {
            if(!ROLES.BLOOD.includes(myRole)) return;
            const s = currentSessionData;
            if(s.blood_res.irreg_type !== val) {
                let msg = (val==='pos') ? "ä¸è¦å‰‡æŠ—ä½“: ã‚ã‚Š" : "ä¸è¦å‰‡æŠ—ä½“: ãªã—";
                db.collection("mtp_sessions").doc(currentSessionId).update({
                    "blood_res.irreg_type": val,
                    logs: firebase.firestore.FieldValue.arrayUnion({t:getTime(), r:myRole, m:`ğŸ©¸ ${msg}`}),
                    chats: firebase.firestore.FieldValue.arrayUnion({t:getTime(), r:myRole, m:`ğŸ©¸ ${msg}`})
                });
            }
        }

        // ãƒãƒ£ãƒƒãƒˆé€ä¿¡
        function sendChat() {
            const el = document.getElementById("chatInput");
            if(el && el.value.trim()) { postChat(el.value.trim()); el.value=""; }
        }
        
        function postChat(m) {
            if(!currentSessionId) return;
            addLog(`[ãƒãƒ£ãƒƒãƒˆ] ${m}`);
            db.collection("mtp_sessions").doc(currentSessionId).update({
                chats: firebase.firestore.FieldValue.arrayUnion({t:getTime(), r:myRole, m:m})
            });
        }
        
        function addLog(msg) {
            if(!currentSessionId) return;
            db.collection("mtp_sessions").doc(currentSessionId).update({
                logs: firebase.firestore.FieldValue.arrayUnion({t:getTime(), r:myRole, m:msg})
            });
        }
        
        function endMTP() {
            if(!confirm("MTPã‚’çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿï¼ˆæŠ•ä¸ã¯ç¶™ç¶šã§ãã¾ã™ï¼‰")) return;
            db.collection("mtp_sessions").doc(currentSessionId).update({
                status: "ended",
                logs: firebase.firestore.FieldValue.arrayUnion({t:getTime(), r:myRole, m:"ğŸ MTPçµ‚äº†å®£è¨€"}),
                chats: firebase.firestore.FieldValue.arrayUnion({t:getTime(), r:myRole, m:"ğŸ MTPçµ‚äº†"})
            });
        }
        
        function moveToWard() {
            if(!confirm("ç—…æ£Ÿå…¥å®¤ã¨ã—ã¦ç—‡ä¾‹ã‚’å®Œçµã—ã¾ã™ã‹ï¼Ÿ")) return;
            db.collection("mtp_sessions").doc(currentSessionId).update({
                status: "completed",
                logs: firebase.firestore.FieldValue.arrayUnion({t:getTime(), r:myRole, m:"ğŸ¥ ç—…æ£Ÿå…¥å®¤ãƒ»ç—‡ä¾‹å®Œçµ"})
            }).then(() => location.reload());
        }

        // --- Utility ---
        function renderBoxes(session) {
            const container = document.getElementById("boxesContainer");
            const isBlood = ROLES.BLOOD.includes(myRole);
            const isNurse = ['è¨˜éŒ²Ns', 'ä»‹åŠ©Ns', 'MTPæ¬é€è€…', 'è‡¨åºŠå·¥å­¦æŠ€å¸«'].includes(myRole);
            let html = "";
            session.boxes.forEach((box, index) => {
                const hasItems = box.items.length > 0;
                const isCompleted = box.items.every(i => i.status === 'completed');
                const boxClass = (hasItems && !isCompleted) ? "box-card active-box" : "box-card";

                let itemsHtml = box.items.map(item => {
                    let stClass = "st-pending", stText = "æœªå‡¦ç†";
                    if(item.status === 'preparing') { stClass="st-preparing"; stText="æº–å‚™ä¸­"; }
                    if(item.status === 'shipped') { stClass="st-shipped"; stText="å‡ºåº«æ¸ˆ"; }
                    if(item.status === 'arrived') { stClass="st-arrived"; stText="åˆ°ç€"; }
                    if(item.status === 'infusing') { stClass="st-infusing"; stText="æŠ•ä¸ä¸­"; }
                    if(item.status === 'completed') { stClass="st-completed"; stText="å®Œäº†"; }
                    
                    let btn = "";
                    if(isBlood) {
                        if(item.status==='pending') btn = `<button class="btn btn-warning btn-sm" onclick="itemAction('${index}','${item.id}','preparing')">æº–å‚™</button>`;
                        else if(item.status==='preparing') btn = `<button class="btn btn-primary btn-sm" onclick="itemAction('${index}','${item.id}','shipped')">å‡ºåº«</button>`;
                    } else {
                        if(item.status==='shipped') btn = `<button class="btn btn-success btn-sm" onclick="itemAction('${index}','${item.id}','arrived')">åˆ°ç€</button>`;
                        else if(item.status==='arrived') btn = `<button class="btn btn-primary btn-sm" onclick="itemAction('${index}','${item.id}','infusing')">é–‹å§‹</button>`;
                        else if(item.status==='infusing') btn = `<button class="btn btn-success btn-sm" onclick="itemAction('${index}','${item.id}','completed')">å®Œäº†</button>`;
                    }
                    return `<div class="item-row"><div>${item.type} ${item.units}U</div><div class="status-badge-item ${stClass}">${stText}</div><div style="text-align:right;">${btn}</div></div>`;
                }).join("");
                
                let batchBtn = "";
                if(isBlood) {
                    if(box.items.every(i=>i.status==='pending')) batchBtn=`<button class="btn btn-warning btn-sm" onclick="batchBox('${index}','preparing')">ä¸€æ‹¬æº–å‚™</button>`;
                    else if(box.items.some(i=>i.status==='preparing')) batchBtn=`<button class="btn btn-primary btn-sm" onclick="batchBox('${index}','shipped')">ä¸€æ‹¬å‡ºåº«</button>`;
                } else if(isNurse) {
                    if(box.items.some(i=>i.status==='shipped')) batchBtn=`<button class="btn btn-success btn-sm" onclick="batchBox('${index}','arrived')">ä¸€æ‹¬åˆ°ç€</button>`;
                }
                html += `<div class="${boxClass}"><div class="box-header"><span>ğŸ“¦ ${box.name}</span><div>${batchBtn}</div></div><div>${itemsHtml}</div></div>`;
            });
            container.innerHTML = html;
        }

        function renderLab(session, isBlood) {
            const buttons = ['btnA', 'btnB', 'btnO', 'btnAB', 'btnRhP', 'btnRhM', 'btnIrregNeg', 'btnIrregPos'];
            buttons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if(btn) {
                    btn.disabled = !isBlood;
                    btn.classList.remove('selected-abo', 'selected-rh', 'active');
                }
            });
            if(session.blood_res.abo) {
                const aboBtn = document.getElementById('btn' + session.blood_res.abo);
                if(aboBtn) aboBtn.classList.add('selected-abo');
            }
            if(session.blood_res.rh) {
                const rhBtn = document.getElementById('btnRh' + (session.blood_res.rh === '+' ? 'P' : 'M'));
                if(rhBtn) rhBtn.classList.add('selected-rh');
            }
            if(session.blood_res.irreg_type === 'neg') {
                const btn = document.getElementById('btnIrregNeg');
                if(btn) btn.classList.add('active');
            }
            if(session.blood_res.irreg_type === 'pos') {
                const btn = document.getElementById('btnIrregPos');
                if(btn) btn.classList.add('active');
            }
        }

        function renderLogs(s) {
            if(!s.logs) s.logs = [];
            if(!s.chats) s.chats = [];
            
            document.getElementById("tabLog").innerHTML = s.logs.slice().reverse().map(l=>
                `<div class="log-entry"><span style="color:#718096;">[${l.t}]</span> <strong>${l.r}:</strong> ${l.m}</div>`
            ).join("");
            
            const chatEl = document.getElementById("chatArea");
            const wasBottom = (chatEl.scrollHeight - chatEl.scrollTop <= chatEl.clientHeight + 50);
            chatEl.innerHTML = s.chats.map(l=>
                `<div class="log-entry"><span style="color:#718096;">[${l.t}]</span> <strong>${l.r}:</strong> ${l.m}</div>`
            ).join("");
            if(wasBottom) chatEl.scrollTop = chatEl.scrollHeight;
        }

        function updateSummary(s) {
            if(!s.logs) s.logs = [];
            
            let txt = `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
            txt += `     MTPæ´»å‹•è¨˜éŒ²ã‚µãƒãƒªãƒ¼\n`;
            txt += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
            txt += `ã€æ‚£è€…æƒ…å ±ã€‘\n`;
            txt += `  æ‚£è€…ID: ${s.id}\n`;
            txt += `  å ´æ‰€: ${s.location}\n`;
            txt += `  ç™ºå‹•æ™‚åˆ»: ${s.start_time}\n`;
            txt += `  çŠ¶æ…‹: ${s.status === 'active' ? 'MTPç™ºå‹•ä¸­' : s.status === 'ended' ? 'MTPçµ‚äº†' : 'å®Œçµ'}\n\n`;
            
            if(s.blood_res.abo && s.blood_res.rh) {
                txt += `ã€è¡€æ¶²å‹ã€‘\n`;
                txt += `  ${s.blood_res.abo}å‹ Rh(${s.blood_res.rh})\n`;
                if(s.blood_res.irreg_type) {
                    txt += `  ä¸è¦å‰‡æŠ—ä½“: ${s.blood_res.irreg_type === 'pos' ? 'ã‚ã‚Š' : 'ãªã—'}\n`;
                }
                txt += `\n`;
            }
            
            txt += `ã€ç´¯è¨ˆæŠ•ä¸é‡ã€‘\n`;
            txt += `  RBC: ${s.used.RBC} å˜ä½\n`;
            txt += `  FFP: ${s.used.FFP} å˜ä½\n`;
            txt += `  PC: ${s.used.PC} å˜ä½\n\n`;
            
            txt += `ã€æ™‚ç³»åˆ—æŠ•ä¸çµŒéã€‘\n`;
            let infusionLogs = s.logs.filter(l => l.m.includes('æŠ•ä¸é–‹å§‹') || l.m.includes('æŠ•ä¸å®Œäº†') || l.m.includes('åˆ°ç€') || l.m.includes('å‡ºåº«'));
            if(infusionLogs.length > 0) {
                infusionLogs.forEach(log => {
                    txt += `  [${log.t}] ${log.m}\n`;
                });
            } else {
                txt += `  (æŠ•ä¸è¨˜éŒ²ãªã—)\n`;
            }
            txt += `\n`;
            txt += `ã€å…¨æ´»å‹•ãƒ­ã‚°ã€‘\n`;
            txt += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
            s.logs.forEach(l => {
                txt += `[${l.t}] ${l.r}: ${l.m}\n`;
            });
            txt += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
            
            document.getElementById('realtimeSummary').value = txt;
        }

        function copySummary() {
            const textarea = document.getElementById('realtimeSummary');
            textarea.select();
            document.execCommand('copy');
            alert('ã‚µãƒãƒªãƒ¼ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
        }

        function generateStockTableHTML(idPrefix, editable) {
            const products = [{k:'RBC', s:2}, {k:'FFP', s:2}, {k:'PC', s:10}];
            let rows = products.map(p => {
                const cols = ['A','B','O','AB'].map(t => {
                    const id = `${idPrefix}_${p.k}_${t}`;
                    const attr = editable ? `onfocus="onStockFocus()" oninput="onStockInput(this)" onchange="onStockChange(this)" onkeydown="onStockKeyDown(event, this)"` : `disabled`;
                    return `<td><input type="number" id="${id}" min="0" step="${p.s}" class="stock-input" ${attr}></td>`;
                }).join("");
                return `<tr><th>${p.k}</th>${cols}</tr>`;
            }).join("");
            return `<table class="stock-table"><thead><tr><th>è£½å‰¤</th><th>A</th><th>B</th><th>O</th><th>AB</th></tr></thead><tbody>${rows}</tbody></table>`;
        }

        function openStockEdit() { document.getElementById("stockEditModal").classList.add("active"); }
        function closeStockEdit() { document.getElementById("stockEditModal").classList.remove("active"); }
        function showTab(n) {
            document.getElementById("tabLog").classList.add("hidden");
            document.getElementById("tabChat").classList.add("hidden");
            document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
            const btns = document.querySelectorAll(".tab-btn");
            if(n==='chat') { btns[0].classList.add("active"); document.getElementById("tabChat").classList.remove("hidden"); }
            else { btns[1].classList.add("active"); document.getElementById("tabLog").classList.remove("hidden"); }
        }
        function showBloodPopup(a,r) {
            document.getElementById('bloodPopupText').textContent = `${a}å‹ Rh(${r})`;
            document.getElementById('bloodPopup').classList.add('active');
            setTimeout(()=>document.getElementById('bloodPopup').classList.remove('active'), 3000);
        }
        function getTime() { return new Date().toLocaleTimeString('ja-JP', {hour:'2-digit', minute:'2-digit', second:'2-digit'}); }
        
        // Chat Input
        const chatInput = document.getElementById('chatInput');
        if(chatInput) {
            chatInput.addEventListener('keypress', function(e) {
                if(e.key === 'Enter') sendChat();
            });
        }
    </script>
</body>
</html>