<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MTP Cloud Mobile v40.0 (Research Edition)</title>
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <style>
        /* --- Reset & Base --- */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Hiragino Sans", sans-serif; 
            background: #e2e8f0; 
            height: 100dvh; 
            color: #2d3748; 
            overflow: hidden; 
            display: flex;
            flex-direction: column;
            max-width: 480px;
            margin: 0 auto;
            border-left: 1px solid #ccc;
            border-right: 1px solid #ccc;
            background-color: #f0f2f5;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        input, textarea, select { user-select: text; }

        /* --- Header --- */
        .app-header {
            background: #1a202c; color: white; padding: 8px 10px;
            padding-top: env(safe-area-inset-top, 10px);
            flex-shrink: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .role-pill { font-size: 10px; background: #4a5568; padding: 2px 6px; border-radius: 4px; margin-left: 5px; }
        .status-badge { padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: bold; }
        .st-active { background: #e53e3e; color: white; animation: pulse 2s infinite; }
        .st-standby { background: #718096; color: white; }
        .st-completed { background: #2f855a; color: white; }

        /* Stats Bar */
        .stats-bar {
            display: grid; grid-template-columns: 1fr 1fr; gap: 8px;
            background: #fff; padding: 8px; border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            color: #2d3748;
        }
        .stat-group { display: flex; flex-direction: column; align-items: center; }
        .stat-label { font-size: 10px; font-weight: bold; color: #4a5568; margin-bottom: 2px; }
        .stat-vals { display: flex; gap: 10px; font-size: 16px; font-weight: 900; font-family: monospace; }
        .c-red { color: #e53e3e; } .c-yel { color: #d69e2e; } .c-blu { color: #3182ce; }

        /* --- Main Viewport --- */
        .main-viewport { flex: 1; position: relative; overflow: hidden; background: #f7fafc; cursor: grab; }
        .main-viewport:active { cursor: grabbing; }
        .tab-view {
            position: absolute; inset: 0; 
            overflow-y: auto; -webkit-overflow-scrolling: touch;
            padding: 15px; padding-bottom: 80px;
            transform: translateX(100%); transition: transform 0.25s ease-out;
            display: none;
        }
        .tab-view.active-view { transform: translateX(0); display: block; }
        .read-only-overlay { position: relative; }
        .read-only-overlay::after {
            content: "å‚ç…§ãƒ¢ãƒ¼ãƒ‰ (æ“ä½œä¸å¯)";
            position: absolute; inset: 0; background: rgba(255,255,255,0.6);
            z-index: 50; display: flex; align-items: center; justify-content: center;
            font-weight: bold; color: #4a5568; font-size: 16px; text-shadow: 0 1px 2px white;
            pointer-events: all;
        }

        /* --- Bottom Nav --- */
        .bottom-nav {
            background: white; border-top: 1px solid #e2e8f0;
            height: 60px; padding-bottom: env(safe-area-inset-bottom, 0);
            display: grid; grid-template-columns: repeat(4, 1fr);
            flex-shrink: 0; z-index: 100;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #a0aec0; font-size: 10px; font-weight: bold; transition: 0.2s; cursor: pointer;
        }
        .nav-item.active { color: #3182ce; background: #ebf8ff; }
        .nav-icon { font-size: 20px; margin-bottom: 2px; }

        /* --- Components --- */
        .section-title {
            font-size: 14px; font-weight: bold; color: #2d3748;
            border-left: 4px solid #3182ce; padding-left: 8px; margin: 15px 0 10px 0;
            display: flex; align-items: center; justify-content: space-between;
        }

        /* Inventory & Picker */
        .stock-table { width: 100%; border-collapse: separate; border-spacing: 0 8px; margin-bottom: 10px; }
        .stock-table th { color: #4a5568; padding: 2px; font-size: 10px; text-align: center; }
        .stock-table td { padding: 0 4px; }
        .stock-display-btn {
            width: 100%; padding: 12px 0; text-align: center; 
            font-size: 18px; font-weight: bold; color: #2d3748; font-family: monospace;
            background: white; border: 1px solid #cbd5e0; border-radius: 8px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .stock-display-btn.editable { color: #3182ce; border-color: #3182ce; background: #ebf8ff; cursor: pointer; }
        .stock-display-btn:active.editable { background: #bee3f8; }

        /* Modal & Picker */
        #pickerModal, #typeSwapModal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 3000;
            display: none; align-items: flex-end; opacity: 0; transition: opacity 0.2s;
        }
        #pickerModal.show, #typeSwapModal.show { display: flex; opacity: 1; }
        .picker-sheet {
            background: white; width: 100%; border-radius: 16px 16px 0 0;
            padding-bottom: env(safe-area-inset-bottom);
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.1, 0.7, 0.1, 1);
        }
        #pickerModal.show .picker-sheet, #typeSwapModal.show .picker-sheet { transform: translateY(0); }
        .picker-toolbar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 15px; border-bottom: 1px solid #edf2f7; background: #f7fafc; border-radius: 16px 16px 0 0;
        }
        .picker-title { font-weight: bold; font-size: 14px; color: #4a5568; }
        .picker-wheel-container { height: 200px; position: relative; overflow: hidden; background: white; cursor: grab; }
        .picker-wheel-container:active { cursor: grabbing; }
        .picker-wheel { height: 100%; overflow-y: scroll; scroll-snap-type: y mandatory; padding: 80px 0; }
        .picker-wheel::-webkit-scrollbar { display: none; }
        .picker-item {
            height: 40px; display: flex; align-items: center; justify-content: center;
            font-size: 20px; font-weight: bold; color: #a0aec0; scroll-snap-align: center; transition: 0.2s;
        }
        .picker-highlight {
            position: absolute; top: 80px; left: 0; right: 0; height: 40px;
            border-top: 1px solid #e2e8f0; border-bottom: 1px solid #e2e8f0;
            pointer-events: none; background: rgba(49, 130, 206, 0.05);
        }

        /* Buttons & Badges */
        .mtp-btn {
            width: 100%; padding: 12px; border-radius: 8px; border: none; color: white;
            text-align: left; margin-bottom: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative; overflow: hidden; transition: transform 0.1s; cursor: pointer;
        }
        .mtp-btn:active { transform: scale(0.98); }
        .mtp-btn-1 { background: linear-gradient(135deg, #e53e3e 0%, #9b2c2c 100%); }
        .mtp-btn-2 { background: linear-gradient(135deg, #3182ce 0%, #2c5282 100%); }
        .mtp-head { font-size: 16px; font-weight: 900; display: block; margin-bottom: 2px; }
        .mtp-sub { font-size: 11px; opacity: 0.9; }

        .doc-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-bottom: 10px; }
        .doc-btn {
            padding: 8px 2px; border: 1px solid #cbd5e0; border-radius: 6px; background: white;
            font-size: 11px; font-weight: bold; color: #4a5568; text-align: center;
            min-height: 44px; display: flex; align-items: center; justify-content: center;
            flex-direction: column; line-height: 1.2; transition: 0.1s; cursor: pointer;
        }
        .doc-btn:active { background: #ebf8ff; }
        .doc-btn.active-on { color: white; border-color: transparent; box-shadow: inset 0 2px 4px rgba(0,0,0,0.2); }
        .bg-warn { background: #c05621 !important; }
        .bg-blood { background: #805ad5 !important; }
        .bg-med { background: #319795 !important; }
        .bg-ce { background: #d69e2e !important; }
        .bg-selected-blood { background: #38a169 !important; color: white !important; border-color: #2f855a !important; }

        .box-card { background: white; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 10px; overflow: hidden; border-left: 4px solid #cbd5e0; }
        .box-card.active { border-left-color: #3182ce; background: #f7fcff; }
        .box-header { padding: 8px 10px; background: rgba(0,0,0,0.02); border-bottom: 1px solid #edf2f7; display: flex; justify-content: space-between; align-items: center; }
        .box-title { font-weight: bold; font-size: 14px; color: #2d3748; }
        .item-row { display: grid; grid-template-columns: 3fr 2fr 2fr; gap: 5px; padding: 8px 10px; border-bottom: 1px solid #f0f0f0; align-items: center; font-size: 12px; }
        .st-badge { font-size: 10px; padding: 2px 6px; border-radius: 10px; text-align: center; background: #edf2f7; color: #718096; white-space: nowrap; }
        
        .st-preparing { background: #feebc8; color: #c05621; }
        .st-shipped { background: #bee3f8; color: #2b6cb0; }
        .st-arrived { background: #c6f6d5; color: #2f855a; }
        .st-infusing { background: #2b6cb0; color: white; animation: pulse 1.5s infinite; }
        .st-completed { background: #2d3748; color: white; }

        .btn { padding: 6px 12px; border-radius: 4px; border: none; font-weight: bold; font-size: 12px; color: white; cursor: pointer; }
        .btn-sm { padding: 4px 8px; font-size: 10px; }
        .btn-primary { background: #3182ce; } .btn-danger { background: #e53e3e; }
        .btn-success { background: #38a169; } .btn-warn { background: #dd6b20; }
        .btn-outline { background: transparent; border: 1px solid #cbd5e0; color: #4a5568; }

        /* Log & Chat */
        .log-container { display: flex; flex-direction: column; gap: 6px; padding-bottom: 60px; }
        .log-item { font-size: 12px; padding: 5px 0; border-bottom: 1px solid #eee; }
        .log-time { color: #a0aec0; font-size: 10px; margin-right: 4px; }
        #chatOverlay { position: fixed; bottom: 60px; left:0; width:100%; max-width:480px; margin:0 auto; background:white; border-top:1px solid #e2e8f0; padding:8px; z-index:90; display:none; padding-bottom: calc(8px + env(safe-area-inset-bottom)); right:0; }

        /* General Modal */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-card { background: white; border-radius: 12px; width: 100%; max-width: 400px; padding: 20px; max-height: 90vh; overflow-y: auto; }
        .role-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 15px; }
        .role-btn { 
            border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px; text-align: center; 
            font-size: 12px; font-weight: bold; color: #4a5568; display: flex; flex-direction: column; gap: 4px; 
            cursor: pointer;
        }
        .role-btn:active { background: #ebf8ff; border-color: #3182ce; color: #2b6cb0; }
        .session-item { background: #fff; border: 1px solid #cbd5e0; padding: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; position: relative; cursor: pointer; }
        .delete-icon-btn { position: absolute; top: -5px; left: -5px; width: 24px; height: 24px; background: #fff; border: 1px solid #e53e3e; color: #e53e3e; border-radius: 50%; font-size: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 5; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }

        .blood-big { background: #e53e3e; color: white; text-align: center; padding: 10px; border-radius: 8px; margin-bottom: 15px; display: none; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .blood-big.show { display: block; animation: fadeIn 0.5s; }
        .blood-popup { display: none; position: fixed; inset: 0; background: rgba(229, 62, 62, 0.95); z-index: 3000; justify-content: center; align-items: center; flex-direction: column; color: white; animation: flashIn 0.3s; pointer-events: none; }
        .blood-popup h1 { font-size: 24px; margin-bottom: 10px; letter-spacing: 2px; border-bottom: 2px solid white; padding-bottom: 5px; }
        .blood-popup div { font-size: 60px; font-weight: 800; text-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .blood-popup.active { display: flex; }

        .hidden { display: none !important; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes flashIn { 0% { opacity: 0; transform: scale(0.9); } 50% { opacity: 1; transform: scale(1.05); } 100% { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>

    <div id="pickerModal">
        <div class="picker-sheet">
            <div class="picker-toolbar">
                <div class="picker-title" id="pickerTitle">æ•°é‡å¤‰æ›´</div>
                <button class="btn btn-primary" onclick="confirmPicker()">å®Œäº†</button>
            </div>
            <div class="picker-wheel-container">
                <div class="picker-highlight"></div>
                <div class="picker-wheel" id="pickerWheel"></div>
            </div>
        </div>
    </div>

    <div id="typeSwapModal">
        <div class="picker-sheet">
            <div class="picker-toolbar">
                <div class="picker-title" style="color:#e53e3e;">âš ï¸ ä»£æ›¿è¡€æ¶²å‹ã®é¸æŠ</div>
                <button class="btn btn-outline" onclick="closeTypeSwap()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
            <div style="padding:20px; display:grid; grid-template-columns: repeat(4, 1fr); gap:10px;">
                <button class="btn btn-outline" onclick="confirmTypeSwap('A')">Aå‹</button>
                <button class="btn btn-outline" onclick="confirmTypeSwap('B')">Bå‹</button>
                <button class="btn btn-outline" onclick="confirmTypeSwap('O')">Oå‹</button>
                <button class="btn btn-outline" onclick="confirmTypeSwap('AB')">ABå‹</button>
            </div>
            <div style="padding:0 15px 20px; font-size:11px; color:#718096; text-align:center;">
                â€»åœ¨åº«ãƒã‚¹ã‚¿ãƒ¼ã®æ•´åˆæ€§ã®ãŸã‚ã€å®Ÿéš›ã«ä½¿ç”¨ã™ã‚‹å‹ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚<br>ã€Œãƒ—ãƒ­ãƒˆã‚³ãƒ«é€¸è„±ã€ã¨ã—ã¦è¨˜éŒ²ã•ã‚Œã¾ã™ã€‚
            </div>
        </div>
    </div>

    <div id="bloodPopup" class="blood-popup">
        <h1>ğŸ©¸ è¡€æ¶²å‹ç¢ºå®š ğŸ©¸</h1>
        <div id="bloodPopupText">A Rh(+)</div>
    </div>

    <div id="loginModal" class="modal active">
        <div class="modal-card">
            <h2 style="text-align:center; font-size:18px; margin-bottom:5px;">MTP Cloud</h2>
            <p style="text-align:center; font-size:11px; color:#718096;">å½¹å‰²ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
            <div id="stepRole">
                <div class="role-grid">
                    <div class="role-btn" onclick="selectRole('ãƒãƒ¼ãƒ ãƒªãƒ¼ãƒ€ãƒ¼')"><span style="font-size:20px;">ğŸ‘¨â€âš•ï¸</span>ãƒãƒ¼ãƒ ãƒªãƒ¼ãƒ€ãƒ¼<br><span style="font-size:10px;">åŒ»å¸«</span></div>
                    <div class="role-btn" onclick="selectRole('è¼¸è¡€è²¬ä»»è€…')"><span style="font-size:20px;">ğŸ“‹</span>è¼¸è¡€è²¬ä»»è€…<br><span style="font-size:10px;">åŒ»å¸«</span></div>
                    <div class="role-btn" onclick="selectRole('è¨˜éŒ²Ns')"><span style="font-size:20px;">ğŸ“</span>è¨˜éŒ²Ns</div>
                    <div class="role-btn" onclick="selectRole('ä»‹åŠ©Ns')"><span style="font-size:20px;">ğŸ’Š</span>ä»‹åŠ©Ns</div>
                    <div class="role-btn" onclick="selectRole('ç ”ä¿®åŒ»')"><span style="font-size:20px;">ğŸ’‰</span>ç ”ä¿®åŒ»</div>
                    <div class="role-btn" onclick="selectRole('MTPæ¬é€è€…')"><span style="font-size:20px;">ğŸƒ</span>MTPæ¬é€è€…</div>
                    <div class="role-btn" onclick="selectRole('è‡¨åºŠå·¥å­¦æŠ€å¸«')"><span style="font-size:20px;">âš™ï¸</span>è‡¨åºŠå·¥å­¦æŠ€å¸«</div>
                    <div class="role-btn" onclick="selectRole('è¼¸è¡€æ¤œæŸ»éƒ¨')"><span style="font-size:20px;">ğŸ¥</span>è¼¸è¡€æ¤œæŸ»éƒ¨<br><span style="font-size:10px;">åœ¨åº«ãƒ»ç½®æ›</span></div>
                    <div class="role-btn" onclick="selectRole('ç ”ç©¶ãƒ‡ãƒ¼ã‚¿ç®¡ç†è€…')" style="grid-column: span 2; background:#ebf8ff; border-color:#3182ce;"><span style="font-size:20px;">ğŸ“Š</span>ç ”ç©¶ãƒ‡ãƒ¼ã‚¿ç®¡ç†è€…<br><span style="font-size:10px;">ãƒ‡ãƒ¼ã‚¿åˆ†æ</span></div>
                </div>
            </div>
            <div id="stepSession" class="hidden">
                <h3 id="sessionTitle" class="section-title" style="margin-top:0;">é€²è¡Œä¸­ã®ç—‡ä¾‹</h3>
                <div id="adminStockPanel" class="hidden" style="background:#f0f9ff; padding:10px; border-radius:8px; border:1px solid #bee3f8; margin-bottom:15px;">
                    <div style="font-weight:bold; color:#2b6cb0; font-size:12px; margin-bottom:5px;">ğŸ“¦ é™¢å†…åœ¨åº«ãƒã‚¹ã‚¿ãƒ¼ (å³æ™‚åæ˜ )</div>
                    <div id="masterStockTableWrapper" style="overflow-x:auto;"></div>
                </div>
                <div id="researchPanel" class="hidden" style="background:#f0fff4; padding:15px; border-radius:8px; border:1px solid #9ae6b4; margin-bottom:15px; text-align:center;">
                    <h3 style="color:#276749; font-size:16px; margin-bottom:10px;">ğŸ“Š ç ”ç©¶ç”¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹</h3>
                    <p style="font-size:11px; color:#4a5568; margin-bottom:15px;">å…¨ç—‡ä¾‹ã®Time to RBC, æ¯”ç‡éµå®ˆç‡,<br>TXAæŠ•ä¸æ™‚é–“ãªã©ã‚’å«ã‚€è©³ç´°åˆ†æãƒ‡ãƒ¼ã‚¿ã‚’å‡ºåŠ›ã€‚</p>
                    <button class="btn btn-success" style="width:100%; padding:15px;" onclick="downloadAllResearchData()">ğŸ“¥ è©³ç´°è§£æãƒ‡ãƒ¼ã‚¿(CSV)å‡ºåŠ›</button>
                </div>
                <div id="sessionList" style="display:flex; flex-direction:column; gap:8px;"></div>
                <div id="newSessionBlock" style="margin-top:20px; padding-top:15px; border-top:1px dashed #cbd5e0;">
                    <div style="font-size:12px; font-weight:bold; margin-bottom:5px;">æ–°è¦MTPç™ºå‹•</div>
                    <div style="display:flex; gap:5px; align-items:center;">
                        <input type="text" id="newPid" class="stock-input" placeholder="ID" style="border:1px solid #cbd5e0; border-radius:4px; flex:1; text-align:left; padding-left:10px; height:44px;">
                        <select id="newLoc" style="border:1px solid #cbd5e0; border-radius:4px; width:100px; padding:5px; font-size:14px; background:white; height:44px;">
                            <option value="ER">ER</option>
                            <option value="æ•‘æ€¥ç—…æ£Ÿ">æ•‘æ€¥ç—…æ£Ÿ</option>
                            <option value="OR">OR</option>
                        </select>
                        <button class="btn btn-danger" onclick="startNewSession()">ç™ºå‹•</button>
                    </div>
                </div>
                <button class="btn btn-outline" style="width:100%; margin-top:10px;" onclick="backToRole()">æˆ»ã‚‹</button>
            </div>
        </div>
    </div>

    <header class="app-header">
        <div class="header-row">
            <div style="display:flex; align-items:baseline; gap:5px;">
                <span style="font-size:16px; font-weight:bold;">ID: <span id="hdPid">---</span></span>
                <span id="hdRole" class="role-pill">Guest</span>
            </div>
            <div style="display:flex; gap:8px; align-items:center;">
                <div id="hdStatus" class="status-badge st-standby">å¾…æ©Ÿä¸­</div>
                <button class="btn btn-sm btn-outline" style="color:white; border-color:white; font-size:10px; padding:4px 8px;" onclick="exitSession()">é€€å‡º</button>
            </div>
        </div>
        <div class="stats-bar">
            <div class="stat-group" style="border-right:1px solid #e2e8f0;">
                <span class="stat-label">ğŸ“ ç¾å ´åœ¨åº« (æœªæŠ•ä¸)</span>
                <div class="stat-vals">
                    <span class="c-red">R<span id="sRBC">0</span></span>
                    <span class="c-yel">F<span id="sFFP">0</span></span>
                    <span class="c-blu">P<span id="sPC">0</span></span>
                </div>
            </div>
            <div class="stat-group">
                <span class="stat-label">ğŸ’‰ å®Ÿæ–½è¼¸è¡€é‡ (å®Œäº†)</span>
                <div class="stat-vals">
                    <span class="c-red">R<span id="uRBC">0</span></span>
                    <span class="c-yel">F<span id="uFFP">0</span></span>
                    <span class="c-blu">P<span id="uPC">0</span></span>
                </div>
            </div>
        </div>
    </header>

    <div class="main-viewport" id="mainViewport">
        <div id="tabInventory" class="tab-view">
            <div class="section-title">ğŸ¥ é™¢å†…åœ¨åº«ãƒã‚¹ã‚¿ãƒ¼ <span id="stockModeLabel" style="font-size:10px; font-weight:normal; color:#718096;">é–²è¦§ã®ã¿</span></div>
            <div id="viewStockTableWrapper"></div>
            <p style="font-size:10px; color:#718096; margin-top:5px;">â€»è¼¸è¡€æ¤œæŸ»éƒ¨ã®ã¿ç·¨é›†å¯èƒ½ã€‚</p>
        </div>

        <div id="tabAction" class="tab-view active-view">
            <div id="bloodBig" class="blood-big">
                <div style="font-size:10px; opacity:0.8;">BLOOD TYPE CONFIRMED</div>
                <div id="bloodBigText" style="font-size:36px; font-weight:900;"></div>
            </div>

            <div id="panelDoctor">
                <div class="section-title">âš¡ ã‚ªãƒ¼ãƒ€ãƒ¼</div>
                <button class="mtp-btn mtp-btn-1" onclick="orderMTP(1)">
                    <span class="mtp-head">â‘  ç•°å‹é©åˆè¡€ ã‚ªãƒ¼ãƒ€ãƒ¼</span>
                    <span class="mtp-sub">BOX1: Oå‹RBC(3) + ABå‹FFP(3)</span>
                </button>
                <button class="mtp-btn mtp-btn-2" onclick="orderMTP(2)">
                    <span class="mtp-head">â‘¡ åŒå‹è¡€ ã‚ªãƒ¼ãƒ€ãƒ¼ (è¦è¡€å‹)</span>
                    <span class="mtp-sub">BOX2(åŒå‹) + BOX3(PCå«) ã‚’è¿½åŠ </span>
                </button>

                <div id="declarationsBlock">
                    <div class="section-title">ğŸš¨ å®£è¨€ãƒ»æŒ‡ç¤º</div>
                    <div class="doc-grid">
                        <div class="doc-btn" id="btnWarn" onclick="toggleFlag('warn', 'ç•°å‹è¼¸è¡€å®£è¨€', 'bg-warn')">âš ï¸ ç•°å‹è¼¸è¡€<br>å®£è¨€</div>
                        <div class="doc-btn" id="btnBlood" onclick="toggleFlag('blood', 'æ¡è¡€2å›æ¸ˆ', 'bg-blood')">ğŸ’‰ æ¡è¡€<br>2å›æ¸ˆ</div>
                        <div class="doc-btn" style="border-color:#e53e3e; color:#e53e3e;" onclick="endMTP()">ğŸ MTP<br>çµ‚äº†å®£è¨€</div>
                    </div>
                </div>

                <div class="section-title">ğŸ’Š è–¬å‰¤æŠ•ä¸</div>
                <div class="doc-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="doc-btn" id="btnFib" onclick="toggleMed('fib', 'ãƒ•ã‚£ãƒ–ãƒªãƒã‚²ãƒ³')">ãƒ•ã‚£ãƒ–ãƒªãƒã‚²ãƒ³</div>
                    <div class="doc-btn" id="btnTrans" onclick="toggleMed('trans', 'ãƒˆãƒ©ãƒ³ã‚µãƒŸãƒ³')">ãƒˆãƒ©ãƒ³ã‚µãƒŸãƒ³</div>
                    <div class="doc-btn" id="btnCa" onclick="toggleMed('ca', 'ã‚«ãƒ«ãƒã‚³ãƒ¼ãƒ«')">Caè£½å‰¤</div>
                    <div class="doc-btn" id="btnK2" onclick="toggleMed('k2', 'K2')">ã‚±ã‚¤ãƒ„ãƒ¼</div>
                    <div class="doc-btn" id="btnKcentra" onclick="toggleMed('kcentra', 'ã‚±ã‚¤ã‚»ãƒ³ãƒˆãƒ©')">ã‚±ã‚¤ã‚»ãƒ³ãƒˆãƒ©</div>
                    <div class="doc-btn" id="btnPrax" onclick="toggleMed('prax', 'ãƒ—ãƒªã‚ºãƒã‚¤ãƒ³ãƒ‰')">ãƒ—ãƒªã‚ºãƒã‚¤ãƒ³ãƒ‰</div>
                </div>
            </div>

            <div id="panelCE" class="hidden">
                <div class="section-title">âš™ï¸ MEã‚¢ã‚¯ã‚·ãƒ§ãƒ³</div>
                <div class="doc-btn" id="btnRapid" onclick="toggleFlag('rapid', 'Rapid Infuser', 'bg-ce')" style="width:100%; font-size:14px; height:50px;">âš¡ ãƒ©ãƒ”ãƒƒãƒ‰ã‚¤ãƒ³ãƒ’ãƒ¥ãƒ¼ã‚¶ãƒ¼é–‹å§‹</div>
            </div>

            <div id="panelLab" class="hidden">
                <div class="section-title">ğŸ©¸ è¡€æ¶²å‹ç¢ºå®š</div>
                <div class="doc-grid" style="grid-template-columns: repeat(4, 1fr);">
                    <div class="doc-btn" id="btnA" onclick="setBlood('A')">A</div>
                    <div class="doc-btn" id="btnB" onclick="setBlood('B')">B</div>
                    <div class="doc-btn" id="btnO" onclick="setBlood('O')">O</div>
                    <div class="doc-btn" id="btnAB" onclick="setBlood('AB')">AB</div>
                </div>
                <div class="doc-grid" style="grid-template-columns: repeat(2, 1fr);">
                    <div class="doc-btn" id="btnRhP" onclick="setRh('+')">Rh(+)</div>
                    <div class="doc-btn" id="btnRhM" onclick="setRh('-')">Rh(-)</div>
                </div>
                <div style="background:white; padding:8px; border:1px solid #cbd5e0; border-radius:6px; font-size:11px;">
                    <strong>ä¸è¦å‰‡æŠ—ä½“:</strong>
                    <div style="display:flex; gap:10px; margin-top:5px;">
                        <button class="btn btn-sm btn-outline" id="btnIrregNeg" style="flex:1;" onclick="setIrreg('neg')">ãªã—</button>
                        <button class="btn btn-sm btn-outline" id="btnIrregPos" style="flex:1;" onclick="setIrreg('pos')">ã‚ã‚Š</button>
                    </div>
                </div>
            </div>

            <div class="section-title">ğŸ“¦ è¼¸è¡€ãƒãƒƒã‚°çŠ¶æ³</div>
            <div id="boxesContainer"></div>
            <div style="height:40px;"></div>
            <button id="btnComplete" class="btn btn-outline" style="width:100%; margin-bottom:20px;" onclick="moveToWard()">ğŸ¥ ç—…æ£Ÿå…¥å®¤ (å®Œçµ)</button>
        </div>

        <div id="tabLog" class="tab-view">
            <div class="section-title">ğŸ’¬ ãƒãƒ£ãƒƒãƒˆãƒ»ãƒ­ã‚°</div>
            <div id="logContainer" class="log-container"></div>
        </div>

        <div id="tabSummary" class="tab-view">
            <div class="section-title">ğŸ“ è¨˜éŒ²ã‚µãƒãƒªãƒ¼ <button class="btn btn-sm btn-primary" onclick="copySummary()">ã‚³ãƒ”ãƒ¼</button></div>
            <textarea id="summaryText" style="width:100%; height:300px; padding:10px; font-size:11px; font-family:monospace; border:1px solid #cbd5e0; border-radius:6px;" readonly></textarea>
        </div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item" onclick="changeTab('tabInventory', this)"><span class="nav-icon">ğŸ“Š</span>åœ¨åº«</div>
        <div class="nav-item active" onclick="changeTab('tabAction', this)"><span class="nav-icon">âš¡</span>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</div>
        <div class="nav-item" onclick="changeTab('tabLog', this)"><span class="nav-icon">ğŸ’¬</span>ãƒ­ã‚°</div>
        <div class="nav-item" onclick="changeTab('tabSummary', this)"><span class="nav-icon">ğŸ“</span>ã‚µãƒãƒªãƒ¼</div>
    </nav>

    <div id="chatOverlay">
        <div style="display:flex; gap:5px; overflow-x:auto; padding-bottom:5px; margin-bottom:5px;" id="cannedArea"></div>
        <div style="display:flex; gap:5px;">
            <input type="text" id="chatInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸..." style="flex:1; padding:8px; border:1px solid #cbd5e0; border-radius:4px;">
            <button class="btn btn-primary btn-sm" onclick="sendChat()">é€ä¿¡</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDdqljAVfjGzKWAA1oWsbnwIphifYMnr-E",
            authDomain: "mtp-project-c8f20.firebaseapp.com",
            projectId: "mtp-project-c8f20",
            storageBucket: "mtp-project-c8f20.firebasestorage.app",
            messagingSenderId: "48202967020",
            appId: "1:48202967020:web:626950d14dfb088200c2c9",
            measurementId: "G-QPM4YE65VH"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        auth.signInAnonymously().catch(e=>alert("Auth Error: "+e.message));

        let myRole = "";
        let currentSessionId = null;
        let currentSessionData = null;
        let hospitalStock = {RBC:{A:6,B:6,O:6,AB:6},FFP:{A:6,B:6,O:6,AB:6},PC:{A:10,B:10,O:10,AB:10}};
        let lastBloodState = "";
        let bloodPopupShown = false; 
        let unsubscribeInventory = null;
        let unsubscribeSession = null;
        let pickerTarget = null; 
        let swapTarget = null; // {bIdx, iIdx}

        const ROLES = {
            MANAGER: ['ç ”ç©¶ãƒ‡ãƒ¼ã‚¿ç®¡ç†è€…'], ADMIN: ['è¼¸è¡€æ¤œæŸ»éƒ¨'], LEADER: ['ãƒãƒ¼ãƒ ãƒªãƒ¼ãƒ€ãƒ¼'],
            DOCTOR: ['ãƒãƒ¼ãƒ ãƒªãƒ¼ãƒ€ãƒ¼', 'ç ”ä¿®åŒ»', 'è¼¸è¡€è²¬ä»»è€…'], NURSE: ['è¨˜éŒ²Ns', 'ä»‹åŠ©Ns'],
            CE: ['è‡¨åºŠå·¥å­¦æŠ€å¸«'], TRANS: ['MTPæ¬é€è€…', 'è‡¨åºŠå·¥å­¦æŠ€å¸«']
        };

        const CANNED = {
            DOCTOR: ['é–‹è…¹è¡“é–‹å§‹', 'IVRé–‹å§‹', 'ãƒã‚¤ã‚¿ãƒ«ä¸å®‰å®š', 'REBOAæŒ¿å…¥', 'æ­¢è¡€ç¢ºèª'],
            ADMIN: ['ç•°å‹ã§å‡ºåº«', 'åŒå‹æœªã‚¯ãƒ­ã‚¹ã§å‡ºåº«', 'ä»¥å¾Œã‚¯ãƒ­ã‚¹ãƒãƒƒãƒæ¸ˆã¿', 'åŒå‹è¡€åœ¨åº«ãŒåˆ‡ã‚Œã¾ã™'],
            NURSE: ['åˆ°ç€', 'æŠ•ä¸é–‹å§‹', 'æ€¥é€Ÿè¼¸è¡€ä¸­', 'è¡€å‹æå‡ºæ¸ˆ'],
            TRANS: ['åˆ°ç€', 'æ¬¡ã®ã‚ªãƒ¼ãƒ€ãƒ¼ä¾é ¼', 'äº†è§£']
        };

        function generateAutoId() {
            const now = new Date();
            return `${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}${now.getHours().toString().padStart(2,'0')}${now.getMinutes().toString().padStart(2,'0')}`;
        }

        function selectRole(role) {
            if (ROLES.MANAGER.includes(role)) {
                if (prompt("ç®¡ç†è€…ID") !== "185383" || prompt("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰") !== "Love99mtp") return alert("èªè¨¼å¤±æ•—");
            }
            myRole = role;
            document.getElementById('hdRole').textContent = role;
            document.getElementById('stepRole').classList.add('hidden');
            document.getElementById('stepSession').classList.remove('hidden');

            const isManager = ROLES.MANAGER.includes(role);
            const isAdmin = ROLES.ADMIN.includes(role);
            
            if(!isManager) document.getElementById('newPid').value = generateAutoId();

            if(isManager) {
                document.getElementById('researchPanel').classList.remove('hidden');
                document.getElementById('sessionList').classList.add('hidden');
                document.getElementById('newSessionBlock').classList.add('hidden');
                document.getElementById('sessionTitle').textContent = "ç®¡ç†è€…ãƒ¡ãƒ‹ãƒ¥ãƒ¼";
                return; 
            } else {
                document.getElementById('researchPanel').classList.add('hidden');
                document.getElementById('sessionList').classList.remove('hidden');
                document.getElementById('newSessionBlock').classList.remove('hidden');
            }

            if(isAdmin) {
                document.getElementById('adminStockPanel').classList.remove('hidden');
                document.getElementById('sessionTitle').textContent = "åœ¨åº«ç®¡ç† / ç—‡ä¾‹é¸æŠ";
                renderStockTable('masterStockTableWrapper', true);
            } else {
                document.getElementById('adminStockPanel').classList.add('hidden');
                document.getElementById('sessionTitle').textContent = "é€²è¡Œä¸­ã®ç—‡ä¾‹";
            }
            document.getElementById('stockModeLabel').textContent = isAdmin ? "ç·¨é›†å¯èƒ½" : "é–²è¦§ã®ã¿";
            renderStockTable('viewStockTableWrapper', isAdmin);
            startInventorySync();
            loadActiveSessions();
        }

        function backToRole() {
            document.getElementById('stepRole').classList.remove('hidden');
            document.getElementById('stepSession').classList.add('hidden');
            if(unsubscribeInventory) unsubscribeInventory();
        }

        function exitSession() {
            if(!currentSessionId) return;
            currentSessionId = null; currentSessionData = null; bloodPopupShown = false; lastBloodState = "";
            document.getElementById('bloodBigText').textContent = "";
            document.getElementById('bloodBig').classList.remove('show');
            document.querySelectorAll('.bg-selected-blood').forEach(el => el.classList.remove('bg-selected-blood'));
            document.getElementById('newPid').value = generateAutoId();
            if(unsubscribeSession) { unsubscribeSession(); unsubscribeSession=null; }
            document.getElementById('loginModal').classList.add('active');
            document.querySelectorAll('.tab-view').forEach(el => el.classList.remove('active-view'));
            document.getElementById('tabAction').classList.add('active-view');
            document.getElementById('stepSession').classList.remove('hidden');
            document.getElementById('stepRole').classList.add('hidden');
        }

        function changeTab(tabId, navEl) {
            document.querySelectorAll('.tab-view').forEach(el => el.classList.remove('active-view'));
            document.getElementById(tabId).classList.add('active-view');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if(navEl) navEl.classList.add('active');
            const overlay = document.getElementById('chatOverlay');
            if(tabId === 'tabLog' && !document.getElementById('tabLog').classList.contains('read-only-overlay')) {
                overlay.style.display = 'block'; renderCanned();
            } else { overlay.style.display = 'none'; }
        }

        // Swipe & Wheel
        let touchStartX=0; let isMouseDown=false;
        const viewport = document.getElementById('mainViewport');
        viewport.addEventListener('touchstart', e => touchStartX = e.changedTouches[0].screenX);
        viewport.addEventListener('touchend', e => { if (e.changedTouches[0].screenX < touchStartX - 50) nextTab(); if (e.changedTouches[0].screenX > touchStartX + 50) prevTab(); });
        viewport.addEventListener('mousedown', e => { touchStartX = e.screenX; isMouseDown = true; });
        viewport.addEventListener('mouseup', e => { if(isMouseDown) { if (e.screenX < touchStartX - 50) nextTab(); if (e.screenX > touchStartX + 50) prevTab(); } isMouseDown = false; });
        viewport.addEventListener('mouseleave', () => isMouseDown = false);
        function nextTab() { const c = document.querySelector('.nav-item.active'); if(c && c.nextElementSibling) c.nextElementSibling.click(); }
        function prevTab() { const c = document.querySelector('.nav-item.active'); if(c && c.previousElementSibling) c.previousElementSibling.click(); }

        const wheel = document.getElementById('pickerWheel');
        let isWheelDown=false, wY, wS;
        wheel.addEventListener('mousedown', e=>{isWheelDown=true; wY=e.pageY; wS=wheel.scrollTop;});
        wheel.addEventListener('mousemove', e=>{if(isWheelDown){e.preventDefault(); wheel.scrollTop=wS-(e.pageY-wY)*1.5;}});
        wheel.addEventListener('mouseup', ()=>isWheelDown=false); wheel.addEventListener('mouseleave', ()=>isWheelDown=false);

        // Inventory
        function renderStockTable(wId, editable) {
            const el = document.getElementById(wId); if(!el) return;
            let html = `<table class="stock-table"><thead><tr><th></th><th>A</th><th>B</th><th>O</th><th>AB</th></tr></thead><tbody>`;
            ['RBC','FFP','PC'].forEach(p => {
                html += `<tr><td style="font-weight:bold; background:#edf2f7; text-align:center;">${p}</td>`;
                ['A','B','O','AB'].forEach(t => {
                    const id = `inv_${wId}_${p}_${t}`;
                    const cls = editable ? 'stock-display-btn editable' : 'stock-display-btn';
                    const clickFn = editable ? `onclick="openPicker('${p}','${t}')"` : '';
                    html += `<td><div id="${id}" class="${cls}" ${clickFn}>-</div></td>`;
                }); html += `</tr>`;
            }); el.innerHTML = html + `</tbody></table>`;
        }
        function startInventorySync() {
            unsubscribeInventory = db.collection("master").doc("inventory").onSnapshot(doc => {
                hospitalStock = doc.exists ? doc.data() : {RBC:{A:6,B:6,O:6,AB:6},FFP:{A:6,B:6,O:6,AB:6},PC:{A:10,B:10,O:10,AB:10}};
                if(!doc.exists) db.collection("master").doc("inventory").set(hospitalStock);
                updateAllStockDisplays();
            });
        }
        function updateAllStockDisplays() {
            ['masterStockTableWrapper', 'viewStockTableWrapper'].forEach(wId => {
                if(document.getElementById(wId)) {
                    ['RBC','FFP','PC'].forEach(p => { ['A','B','O','AB'].forEach(t => {
                        const el = document.getElementById(`inv_${wId}_${p}_${t}`);
                        if(el) el.textContent = (hospitalStock[p]&&hospitalStock[p][t]!==undefined)?hospitalStock[p][t]:(p==='PC'?10:6);
                    });});
                }
            });
        }
        function openPicker(prod, type) {
            pickerTarget = {prod, type};
            const val = (hospitalStock[prod] && hospitalStock[prod][type] !== undefined) ? hospitalStock[prod][type] : (prod==='PC'?10:6);
            document.getElementById('pickerTitle').textContent = `${prod} (${type}å‹) æ•°é‡å¤‰æ›´`;
            const wheel = document.getElementById('pickerWheel');
            let html = ""; const step = (prod==='PC')?10:2;
            for(let i=0; i<=((prod==='PC')?200:100); i+=step) html += `<div class="picker-item" data-val="${i}">${i}</div>`;
            wheel.innerHTML = html;
            document.getElementById('pickerModal').classList.add('show');
            setTimeout(() => { wheel.scrollTop = (val/step)*40; }, 10);
        }
        function confirmPicker() {
            if(!pickerTarget) return;
            const index = Math.round(document.getElementById('pickerWheel').scrollTop / 40);
            const val = index * ((pickerTarget.prod==='PC')?10:2);
            db.collection("master").doc("inventory").update({ [`${pickerTarget.prod}.${pickerTarget.type}`]: val });
            document.getElementById('pickerModal').classList.remove('show'); pickerTarget = null;
        }

        // Session Logic
        function loadActiveSessions() {
            const list = document.getElementById('sessionList');
            db.collection("mtp_sessions").orderBy("start_time", "desc").limit(20).onSnapshot(snap => {
                if(snap.empty) { list.innerHTML = "<div style='text-align:center; padding:20px; color:#a0aec0;'>ãªã—</div>"; return; }
                list.innerHTML = snap.docs.map(doc => {
                    const d = doc.data(); const isC = d.status === 'completed';
                    const del = ROLES.LEADER.includes(myRole) ? `<div class="delete-icon-btn" onclick="deleteSession('${doc.id}', event)">ğŸ—‘ï¸</div>` : '';
                    return `<div class="session-item" onclick="joinSession('${doc.id}')">${del}
                        <div><div style="font-weight:bold; font-size:16px;">${d.id} <span style="font-size:10px; padding:2px 4px; border-radius:4px; ${isC?"color:#718096; background:#edf2f7;":"color:#3182ce; background:#ebf8ff;"}">${isC?"ã€å®Œäº†ã€‘å±¥æ­´":"é€²è¡Œä¸­"}</span></div>
                        <div style="font-size:11px; color:#718096;">${d.location} (${d.start_time})</div></div>
                        <button class="btn btn-sm btn-primary">${isC?"å‚ç…§":"å‚åŠ "}</button></div>`;
                }).join("");
            });
        }
        function startNewSession() {
            const pid = document.getElementById('newPid').value.trim();
            if(!pid) return alert("IDã‚’å…¥åŠ›");
            db.collection("mtp_sessions").doc(pid).set({
                id: pid, location: document.getElementById('newLoc').value, status: 'active',
                start_time: new Date().toLocaleTimeString('ja-JP', {hour:'2-digit', minute:'2-digit'}),
                boxes: [], logs: [], chats: [], used: {RBC:0, FFP:0, PC:0},
                blood_res: {abo:'', rh:'', irreg:''}, flags: {}, meds: {}
            }).then(() => joinSession(pid));
        }
        function deleteSession(id, e) { e.stopPropagation(); if(confirm("å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) db.collection("mtp_sessions").doc(id).delete(); }
        function joinSession(id) {
            lastBloodState = ""; bloodPopupShown = false; 
            document.querySelectorAll('.bg-selected-blood').forEach(el=>el.classList.remove('bg-selected-blood'));
            currentSessionId = id; document.getElementById('hdPid').textContent = id;
            document.getElementById('loginModal').classList.remove('active');
            
            if(!ROLES.DOCTOR.includes(myRole)) document.getElementById('panelDoctor').classList.add('hidden');
            if(ROLES.CE.includes(myRole)) document.getElementById('panelCE').classList.remove('hidden');
            if(ROLES.ADMIN.includes(myRole)) document.getElementById('panelLab').classList.remove('hidden');

            const isRes = (myRole === 'ç ”ä¿®åŒ»');
            document.getElementById('declarationsBlock').style.display = isRes ? 'none' : 'block';
            document.getElementById('btnComplete').style.display = isRes ? 'none' : 'block';

            unsubscribeSession = db.collection("mtp_sessions").doc(id).onSnapshot(doc => {
                if(!doc.exists) { alert("å‰Šé™¤ã•ã‚Œã¾ã—ãŸ"); exitSession(); return; }
                currentSessionData = doc.data(); renderScreen(currentSessionData);
            });
        }

        // Render Screen
        function renderScreen(data) {
            const isRO = data.status === 'completed';
            if(isRO) {
                document.getElementById('tabAction').classList.add('read-only-overlay');
                document.getElementById('tabInventory').classList.add('read-only-overlay');
                document.getElementById('chatOverlay').style.display='none';
                document.getElementById('btnComplete').style.display='none';
                document.getElementById('hdStatus').textContent="å®Œäº†"; document.getElementById('hdStatus').className="status-badge st-completed";
            } else {
                document.getElementById('tabAction').classList.remove('read-only-overlay');
                document.getElementById('tabInventory').classList.remove('read-only-overlay');
                if(document.getElementById('tabLog').classList.contains('active-view')) document.getElementById('chatOverlay').style.display='block';
                if(myRole !== 'ç ”ä¿®åŒ»') document.getElementById('btnComplete').style.display='block';
                document.getElementById('hdStatus').textContent="ç™ºå‹•ä¸­"; document.getElementById('hdStatus').className="status-badge st-active";
            }

            // Stats
            document.getElementById('uRBC').textContent = data.used.RBC; document.getElementById('uFFP').textContent = data.used.FFP; document.getElementById('uPC').textContent = data.used.PC;
            let s = {RBC:0, FFP:0, PC:0};
            data.boxes.forEach(b => { b.items.forEach(i => { if(i.status==='arrived'){ if(i.type.includes('RBC'))s.RBC+=i.units; else if(i.type.includes('FFP'))s.FFP+=i.units; else if(i.type.includes('PC'))s.PC+=i.units; } }); });
            document.getElementById('sRBC').textContent = s.RBC; document.getElementById('sFFP').textContent = s.FFP; document.getElementById('sPC').textContent = s.PC;

            // Blood Popups
            if(data.blood_res.abo && data.blood_res.rh) {
                const cb = `${data.blood_res.abo} Rh(${data.blood_res.rh})`;
                if(lastBloodState !== "" && lastBloodState !== cb && !bloodPopupShown) {
                    document.getElementById('bloodPopupText').textContent = cb;
                    const p = document.getElementById('bloodPopup'); p.classList.add('active');
                    playBeep(); setTimeout(()=>p.classList.remove('active'), 3000); bloodPopupShown=true;
                }
                if(lastBloodState === "") lastBloodState = cb;
                document.getElementById('bloodBig').classList.add('show'); document.getElementById('bloodBigText').textContent = cb;
            }

            // Styles
            ['btnA','btnB','btnO','btnAB','btnRhP','btnRhM'].forEach(id => document.getElementById(id)?.classList.remove('bg-selected-blood'));
            if(data.blood_res.abo) document.getElementById('btn'+data.blood_res.abo).classList.add('bg-selected-blood');
            if(data.blood_res.rh) document.getElementById(data.blood_res.rh==='+'?'btnRhP':'btnRhM').classList.add('bg-selected-blood');
            document.getElementById('btnIrregNeg').className = data.blood_res.irreg==='neg' ? "btn btn-sm btn-success" : "btn btn-sm btn-outline";
            document.getElementById('btnIrregPos').className = data.blood_res.irreg==='pos' ? "btn btn-sm btn-danger" : "btn btn-sm btn-outline";

            // Boxes
            const bc = document.getElementById('boxesContainer');
            bc.innerHTML = data.boxes.map((b, bIdx) => {
                let batch = "";
                if(!isRO) {
                    if(ROLES.ADMIN.includes(myRole)) {
                        if(b.items.every(i=>i.status==='pending')) batch=`<button class="btn btn-sm btn-warn" onclick="batchAction(${bIdx},'preparing')">ä¸€æ‹¬æº–å‚™</button>`;
                        else if(b.items.some(i=>i.status==='preparing')) batch=`<button class="btn btn-sm btn-primary" onclick="batchAction(${bIdx},'shipped')">ä¸€æ‹¬å‡ºåº«</button>`;
                    }
                    if(ROLES.NURSE.includes(myRole)||ROLES.TRANS.includes(myRole)) {
                        if(b.items.some(i=>i.status==='shipped')) batch=`<button class="btn btn-sm btn-success" onclick="batchAction(${bIdx},'arrived')">ä¸€æ‹¬åˆ°ç€</button>`;
                    }
                }
                const rows = b.items.map((i, iIdx) => {
                    let btn = "";
                    if(!isRO) {
                        if(ROLES.ADMIN.includes(myRole)) {
                            if(i.status==='pending') btn=`<button class="btn btn-sm btn-outline" onclick="updateItem(${bIdx},${iIdx},'preparing')">æº–å‚™</button>`;
                            else if(i.status==='preparing') btn=`<button class="btn btn-sm btn-primary" onclick="updateItem(${bIdx},${iIdx},'shipped')">å‡ºåº«</button>`;
                        }
                        if(ROLES.NURSE.includes(myRole)||ROLES.TRANS.includes(myRole)||ROLES.CE.includes(myRole)) {
                            if(i.status==='shipped') btn=`<button class="btn btn-sm btn-success" onclick="updateItem(${bIdx},${iIdx},'arrived')">åˆ°ç€</button>`;
                            else if(i.status==='arrived') btn=`<button class="btn btn-sm btn-primary" onclick="updateItem(${bIdx},${iIdx},'infusing')">é–‹å§‹</button>`;
                            else if(i.status==='infusing') btn=`<button class="btn btn-sm btn-outline" onclick="updateItem(${bIdx},${iIdx},'completed')">å®Œäº†</button>`;
                        }
                    }
                    // v40.0: Click name to swap (Admin Only)
                    let nameAction = "";
                    if(ROLES.ADMIN.includes(myRole) && (i.status==='pending'||i.status==='preparing')) {
                        nameAction = `onclick="openTypeSwap(${bIdx},${iIdx})" style="cursor:pointer; text-decoration:underline; color:#2b6cb0;"`;
                    }
                    return `<div class="item-row"><div ${nameAction}>${i.type} (${i.units}U)${i.tag?`<span style="font-weight:bold; color:#e53e3e; margin-left:5px;">${i.tag}</span>`:""}</div>
                    <div class="st-badge st-${i.status}">${i.status}</div><div style="text-align:right;">${btn}</div></div>`;
                }).join("");
                return `<div class="box-card ${b.items.every(x=>x.status==='completed')?'':'active'}"><div class="box-header"><span class="box-title">ğŸ“¦ ${b.name}</span><div>${batch}</div></div>${rows}</div>`;
            }).join("");

            // Logs & Summary
            const logs = [...(data.logs||[]), ...(data.chats||[])].sort((a,b)=>a.t>b.t?1:-1);
            document.getElementById('logContainer').innerHTML = logs.slice().reverse().map(l=>`<div class="log-item"><span class="log-time">${l.t}</span> <strong>${l.r}:</strong> ${l.m}</div>`).join("");
            
            ['warn','blood','rapid'].forEach(k=>updateFlag('btn'+k.charAt(0).toUpperCase()+k.slice(1), data.flags?.[k], k==='warn'?'bg-warn':k==='blood'?'bg-blood':'bg-ce'));
            ['fib','trans','k2','prax','kcentra','ca'].forEach(k=>updateFlag('btn'+k.charAt(0).toUpperCase()+k.slice(1), data.meds?.[k], 'bg-med'));

            let sum = `ã€MTPè¨˜éŒ² ID:${data.id}ã€‘\nç·æŠ•ä¸: R${data.used.RBC}/F${data.used.FFP}/P${data.used.PC}\n`;
            if(data.blood_res.abo) sum+=`è¡€æ¶²å‹: ${data.blood_res.abo}${data.blood_res.rh}\n`;
            sum+="\n--- LOGS ---\n"; logs.forEach(l=>sum+=`[${l.t}] ${l.m}\n`);
            document.getElementById('summaryText').value = sum;
        }

        function updateFlag(id, on, cls) { const e=document.getElementById(id); if(e){ if(on)e.classList.add('active-on',cls); else e.classList.remove('active-on',cls); }}

        // v40.0: Bag Type Swap Logic
        function openTypeSwap(bIdx, iIdx) {
            swapTarget = {bIdx, iIdx};
            document.getElementById('typeSwapModal').classList.add('show');
        }
        function closeTypeSwap() {
            document.getElementById('typeSwapModal').classList.remove('show');
            swapTarget = null;
        }
        function confirmTypeSwap(newType) {
            if(!swapTarget) return;
            const ref = db.collection("mtp_sessions").doc(currentSessionId);
            db.runTransaction(async t => {
                const doc = await t.get(ref);
                const d = doc.data();
                const item = d.boxes[swapTarget.bIdx].items[swapTarget.iIdx];
                const oldType = item.type;
                
                // Construct new type string (e.g., "A_RBC")
                const prod = item.type.split('_')[1] || 'RBC';
                item.type = `${newType}_${prod}`;
                item.tag = "âš ï¸ä»£æ›¿"; // Mark as substituted
                
                t.update(ref, { 
                    boxes: d.boxes,
                    logs: firebase.firestore.FieldValue.arrayUnion({t:getTime(), r:myRole, m:`ã€ç½®æ›ã€‘${oldType} â” ${item.type}`})
                });
            });
            closeTypeSwap();
        }

        // Action Logic
        function orderMTP(type) {
            if (type===2 && (!currentSessionData.blood_res?.abo)) return alert("è¡€æ¶²å‹æœªç¢ºå®š");
            const d = currentSessionData; const abo = d.blood_res.abo || 'O';
            const count = (d.boxes||[]).filter(b=>b.name.startsWith(type===1?"BOX1":"BOX2")||b.name.startsWith("BOX3")).length;
            let newBoxes = [];
            if(type===1) {
                newBoxes.push({name:`BOX1-${count+1} (ç•°å‹)`, items:[
                    {type:'O_RBC',units:2,status:'pending'},{type:'O_RBC',units:2,status:'pending'},{type:'O_RBC',units:2,status:'pending'},
                    {type:'AB_FFP',units:2,status:'pending'},{type:'AB_FFP',units:2,status:'pending'},{type:'AB_FFP',units:2,status:'pending'}
                ]});
            } else {
                newBoxes.push({name:`BOX2-${count+1} (åŒå‹)`, items:[
                    {type:`${abo}_RBC`,units:2,status:'pending'},{type:`${abo}_RBC`,units:2,status:'pending'},
                    {type:`${abo}_FFP`,units:2,status:'pending'},{type:`${abo}_FFP`,units:2,status:'pending'}
                ]});
                newBoxes.push({name:`BOX3-${count+1} (PCå«)`, items:[
                    {type:`${abo}_RBC`,units:2,status:'pending'},{type:`${abo}_FFP`,units:2,status:'pending'},
                    {type:`${abo}_PC`,units:10,status:'pending'},{type:`${abo}_PC`,units:10,status:'pending'}
                ]});
            }
            db.collection("mtp_sessions").doc(currentSessionId).update({
                boxes: firebase.firestore.FieldValue.arrayUnion(...newBoxes),
                logs: firebase.firestore.FieldValue.arrayUnion({t:getTime(), r:myRole, m:`ã‚ªãƒ¼ãƒ€ãƒ¼${type===1?"â‘ ":"â‘¡"}æŒ‡ç¤º`})
            });
        }

        function updateItem(bIdx, iIdx, nextSt) {
            const ref = db.collection("mtp_sessions").doc(currentSessionId);
            db.runTransaction(async t => {
                const doc = await t.get(ref);
                const d = doc.data();
                const item = d.boxes[bIdx].items[iIdx];
                if(nextSt==='shipped' && item.status!=='shipped') {
                    const [ty, p] = item.type.split('_');
                    if(hospitalStock[p][ty] < item.units) return alert(`åœ¨åº«ä¸è¶³: ${item.type}`);
                    db.collection("master").doc("inventory").update({ [`${p}.${ty}`]: firebase.firestore.FieldValue.increment(-item.units) });
                }
                if(nextSt==='infusing' && item.status!=='infusing') {
                    // Auto tag logic
                    const myP = item.type.split('_')[1];
                    let c=0; d.boxes.forEach(b=>b.items.forEach(i=>{ if(i.type.includes(myP) && (i.status==='infusing'||i.status==='completed')) c++; }));
                    const map=["â‘ ","â‘¡","â‘¢","â‘£","â‘¤","â‘¥","â‘¦","â‘§","â‘¨","â‘©","â‘ª","â‘«","â‘¬","â‘­","â‘®","â‘¯","â‘°","â‘±","â‘²","â‘³"];
                    if(!item.tag) item.tag = map[c]||`(${c+1})`;
                }
                if(nextSt==='completed') {
                    const p = item.type.split('_')[1];
                    t.update(ref, { [`used.${p}`]: firebase.firestore.FieldValue.increment(item.units) });
                }
                item.status = nextSt;
                t.update(ref, { boxes: d.boxes });
            });
        }

        function batchAction(bIdx, nextSt) {
            if(!confirm("ä¸€æ‹¬æ“ä½œã—ã¾ã™ã‹ï¼Ÿ")) return;
            const ref = db.collection("mtp_sessions").doc(currentSessionId);
            db.runTransaction(async t => {
                const d = (await t.get(ref)).data(); const box = d.boxes[bIdx]; let count=0;
                // Stock Check
                if(nextSt==='shipped') {
                    let req={}; box.items.forEach(i=>{ if(i.status==='preparing'){ const [ty,p]=i.type.split('_'); req[`${p}.${ty}`]=(req[`${p}.${ty}`]||0)+i.units; } });
                    for(let k in req) { const [p,ty]=k.split('.'); if(hospitalStock[p][ty]<req[k]) return alert(`åœ¨åº«ä¸è¶³: ${ty}_${p}`); }
                }
                box.items.forEach(i => {
                    let go=false;
                    if(nextSt==='preparing'&&i.status==='pending') go=true;
                    if(nextSt==='shipped'&&i.status==='preparing') {
                        const [ty,p]=i.type.split('_'); db.collection("master").doc("inventory").update({ [`${p}.${ty}`]: firebase.firestore.FieldValue.increment(-i.units) }); go=true;
                    }
                    if(nextSt==='arrived'&&i.status==='shipped') go=true;
                    if(go){ i.status=nextSt; count++; }
                });
                if(count>0) t.update(ref, { boxes: d.boxes, logs: firebase.firestore.FieldValue.arrayUnion({t:getTime(), r:myRole, m:`${box.name} ä¸€æ‹¬${nextSt}`}) });
            });
        }

        function toggleFlag(k,m) { const v=!currentSessionData.flags?.[k]; db.collection("mtp_sessions").doc(currentSessionId).update({[`flags.${k}`]:v, logs:firebase.firestore.FieldValue.arrayUnion({t:getTime(),r:myRole,m:`${m} ${v?'ON':'OFF'}`})}); }
        function toggleMed(k,m) { const v=!currentSessionData.meds?.[k]; db.collection("mtp_sessions").doc(currentSessionId).update({[`meds.${k}`]:v, logs:firebase.firestore.FieldValue.arrayUnion({t:getTime(),r:myRole,m:`æŠ•ä¸: ${m} ${v?'ON':'OFF'}`})}); }
        function setBlood(v) { if(!ROLES.ADMIN.includes(myRole))return; db.collection("mtp_sessions").doc(currentSessionId).update({'blood_res.abo':v, logs:firebase.firestore.FieldValue.arrayUnion({t:getTime(),r:myRole,m:`è¡€æ¶²å‹: ${v}`})}); }
        function setRh(v) { if(!ROLES.ADMIN.includes(myRole))return; db.collection("mtp_sessions").doc(currentSessionId).update({'blood_res.rh':v, logs:firebase.firestore.FieldValue.arrayUnion({t:getTime(),r:myRole,m:`Rh: ${v}`})}); }
        function setIrreg(v) { if(!ROLES.ADMIN.includes(myRole))return; db.collection("mtp_sessions").doc(currentSessionId).update({'blood_res.irreg':v, logs:firebase.firestore.FieldValue.arrayUnion({t:getTime(),r:myRole,m:`ä¸è¦å‰‡æŠ—ä½“: ${v}`})}); }
        function endMTP() { if(confirm("çµ‚äº†å®£è¨€ã—ã¾ã™ã‹ï¼Ÿ")) db.collection("mtp_sessions").doc(currentSessionId).update({status:'ended'}); }
        
        // v40.0: Research Data Logic
        function moveToWard() {
            if(!confirm("å®Œçµã—ã¾ã™ã‹ï¼Ÿï¼ˆç ”ç©¶ç”¨DBã«ä¿å­˜ï¼‰")) return;
            const d = currentSessionData; const now = new Date();
            
            // Helper to calc minutes diff
            const getMin = (tStr) => { if(!tStr) return ""; const [h,m]=tStr.split(':'); return parseInt(h)*60+parseInt(m); };
            const startMin = getMin(d.start_time);
            const endMin = now.getHours()*60 + now.getMinutes();
            const duration = (endMin >= startMin) ? (endMin - startMin) : (endMin + 1440 - startMin);

            // Find timestamps from logs
            const findTime = (k) => d.logs.find(l=>l.m.includes(k))?.t || "";
            const timeFirstOrder = findTime("ã‚ªãƒ¼ãƒ€ãƒ¼");
            const timeFirstShip = findTime("å‡ºåº«");
            const timeFirstArrive = findTime("åˆ°ç€");
            const timeTXA = findTime("ãƒˆãƒ©ãƒ³ã‚µãƒŸãƒ³ ON");

            // Calculate Metrics
            const calcLag = (t1, t2) => { if(!t1||!t2) return ""; return Math.abs(getMin(t2)-getMin(t1)); };
            
            // First RBC/FFP infusion time (scan boxes)
            let firstRBC="", firstFFP="";
            d.boxes.forEach(b=>{ b.items.forEach(i=>{ 
                if((i.status==='infusing'||i.status==='completed')){
                    // We don't track exact infusion time per item in v40, so we use "First Arrive" as proxy or "Infusing" logs if implemented. 
                    // For now, we use the "åˆ°ç€" log as the closest proxy for "Available at bedside".
                }
            })});

            // Count Deviations
            let deviationCount = 0;
            d.boxes.forEach(b=>b.items.forEach(i=>{ if(i.tag && i.tag.includes("ä»£æ›¿")) deviationCount++; }));

            db.collection("research_logs").doc(d.id).set({
                id: d.id, location: d.location, date: now.toLocaleDateString(),
                startTime: d.start_time, endTime: getTime(), durationMin: duration,
                totalRBC: d.used.RBC, totalFFP: d.used.FFP, totalPC: d.used.PC,
                ratio: d.used.FFP>0 ? (d.used.RBC/d.used.FFP).toFixed(2) : "N/A",
                bloodType: `${d.blood_res.abo||'?'} ${d.blood_res.rh||'?'}`,
                irregularAb: d.blood_res.irreg,
                
                // Time Metrics
                timeOrder: timeFirstOrder, timeShip: timeFirstShip, timeArrive: timeFirstArrive,
                tatMin: timeFirstArrive ? calcLag(d.start_time, timeFirstArrive) : "",
                
                // Meds & Flags
                txa: d.meds?.trans ? "Yes" : "No", timeTXA: timeTXA,
                fibrinogen: d.meds?.fib ? "Yes" : "No",
                calcium: d.meds?.ca ? "Yes" : "No",
                rapidInfuser: d.flags?.rapid ? "Yes" : "No",
                
                // Quality
                protocolDeviation: deviationCount > 0 ? "Yes" : "No",
                substitutedUnits: deviationCount
            });

            db.collection("mtp_sessions").doc(currentSessionId).update({status:'completed'})
            .then(()=>{ alert("å®Œäº†ã€‚ãƒ‡ãƒ¼ã‚¿ä¿å­˜æ¸ˆã€‚"); location.reload(); });
        }

        function downloadAllResearchData() {
            db.collection("research_logs").get().then(snap => {
                if(snap.empty) return alert("ãƒ‡ãƒ¼ã‚¿ãªã—");
                // CSV Header
                let csv = "ID,Location,Date,Duration(min),Total_RBC,Total_FFP,Total_PC,Ratio(R/F),BloodType,IrregAB,Time_Order,Time_Ship,Time_Arrive,TAT(min),TXA,Time_TXA,Fibrinogen,Calcium,RapidInfuser,Protocol_Deviation,Substituted_Units\n";
                snap.forEach(doc => {
                    const d = doc.data();
                    csv += `${d.id},${d.location},${d.date},${d.durationMin},${d.totalRBC},${d.totalFFP},${d.totalPC},${d.ratio},${d.bloodType},${d.irregularAb},${d.timeOrder},${d.timeShip},${d.timeArrive},${d.tatMin},${d.txa},${d.timeTXA},${d.fibrinogen},${d.calcium},${d.rapidInfuser},${d.protocolDeviation},${d.substitutedUnits}\n`;
                });
                const a = document.createElement('a'); a.href = window.URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
                a.download = `MTP_Research_${new Date().toLocaleDateString()}.csv`; a.click();
            });
        }

        function sendChat() { const t=document.getElementById('chatInput').value; if(!t)return; db.collection("mtp_sessions").doc(currentSessionId).update({chats:firebase.firestore.FieldValue.arrayUnion({t:getTime(),r:myRole,m:t})}); document.getElementById('chatInput').value=""; }
        function renderCanned() {
            let l=CANNED.DOCTOR; if(ROLES.ADMIN.includes(myRole))l=CANNED.ADMIN; if(ROLES.NURSE.includes(myRole))l=CANNED.NURSE; if(ROLES.TRANS.includes(myRole))l=CANNED.TRANS;
            document.getElementById('cannedArea').innerHTML=l.map(c=>`<div class="canned-btn" onclick="document.getElementById('chatInput').value='${c}';sendChat()">${c}</div>`).join("");
        }
        function copySummary() { document.getElementById('summaryText').select(); document.execCommand('copy'); alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'); }
        function getTime() { return new Date().toLocaleTimeString('ja-JP', {hour:'2-digit', minute:'2-digit'}); }
        function playBeep() { try{const c=new(window.AudioContext||window.webkitAudioContext)();const t=c.currentTime;[0,0.2,0.4].forEach(d=>{const o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(c.destination);o.type='square';o.frequency.value=880;g.gain.setValueAtTime(0.1,t+d);g.gain.exponentialRampToValueAtTime(0.001,t+d+0.1);o.start(t+d);o.stop(t+d+0.1);})}catch(e){}}
    </script>
</body>
</html>
